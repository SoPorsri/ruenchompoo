<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ - ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: system-ui, "Noto Sans Thai", sans-serif; margin: 0; background-color: #e6fff7; }
    header { background: linear-gradient(90deg, #ec4899, #d946ef); color: white; padding: clamp(12px,2vw,16px); text-align:center; font-size:clamp(16px,2.5vw,20px); font-weight:bold; letter-spacing:0.5px; box-shadow:0 2px 8px rgba(0,0,0,0.2); position:relative; }
    header img { height:100px; vertical-align:middle; margin-right:8px; }
    header span { vertical-align:middle; }

    #setIpBtn {
      position:absolute; right:clamp(10px,2vw,16px); top:calc(0 + clamp(0px,2vw,16px) + 100px);
      background: linear-gradient(135deg, #f59e0b, #d97706); color:#fff; border:none; padding:8px 12px; border-radius:10px;
      cursor:pointer; font-size:13px; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.2); display:inline-flex; align-items:center; gap:8px; z-index:300;
    }
    #setIpBtn i { font-size:14px; }
    #setIpBtn small { display:block; font-weight:400; font-size:11px; opacity:0.95; }
    #setIpBtn:hover { transform: translateY(-2px); }
    @media (max-width:600px){#setIpBtn{padding:6px 10px; font-size:12px; top:calc(0+72px+8px);}}

    #reportButton {
      position:fixed; bottom:6px; right:6px;
      background: linear-gradient(135deg, #FBCFE8,#EC4899,#BE185D); color:#fff; border:none; padding:clamp(8px,1.5vw,12px) clamp(12px,2vw,18px);
      border-radius:50px; cursor:pointer; font-size:clamp(12px,1.8vw,14px); font-weight:600; box-shadow:0 6px 20px rgba(190,24,93,0.35);
      display:flex; align-items:center; gap:4px; transition:transform 0.2s, box-shadow 0.2s; z-index:100;
    }
    #reportButton:hover{transform:translateY(-3px) scale(1.05); box-shadow:0 6px 20px rgba(0,0,0,0.35);}
    #reportButton i{font-size:clamp(14px,1.8vw,18px);}
    @media (max-width:600px){#reportButton{bottom:12px; right:12px; padding:10px 16px; font-size:14px;} #reportButton i{font-size:16px;}}

    .layout { display:grid; grid-template-columns:90px 90px 90px 90px; grid-template-rows:repeat(12,60px); gap:12px; padding:24px; justify-content:center; position:relative; z-index:1; }
    .table-card { display:flex; align-items:center; justify-content:center; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s; box-shadow:0 3px 6px rgba(0,0,0,0.1); padding:6px; text-align:center; }
    .table-card:hover { transform:translateY(-4px) scale(1.05); box-shadow:0 6px 12px rgba(0,0,0,0.15);}
    .free { background: linear-gradient(135deg,#34d399,#10b981); color:white; }
    .busy { background: linear-gradient(135deg,#f87171,#ef4444); color:white; }
    .status-icon { font-size:18px; margin-right:6px; }
    .status-icon.free { color:#bbf7d0; }
    .status-icon.busy { color:#fecaca; }

    #table-‡∏ã‡∏∏‡πâ‡∏°1 { grid-column:1; grid-row:10; } #table-‡∏ã‡∏∏‡πâ‡∏°2 { grid-column:1; grid-row:9; } #table-‡∏ã‡∏∏‡πâ‡∏°3 { grid-column:1; grid-row:8; } #table-‡∏ã‡∏∏‡πâ‡∏°4 { grid-column:1; grid-row:7; } #table-‡∏ã‡∏∏‡πâ‡∏°5 { grid-column:1; grid-row:6; } #table-‡∏ã‡∏∏‡πâ‡∏°6 { grid-column:1; grid-row:5; } #table-‡∏ã‡∏∏‡πâ‡∏°7 { grid-column:1; grid-row:4; } #table-‡∏ã‡∏∏‡πâ‡∏°8 { grid-column:1; grid-row:3; } #table-‡∏ã‡∏∏‡πâ‡∏°9 { grid-column:1; grid-row:2; } #table-‡∏ã‡∏∏‡πâ‡∏°10 { grid-column:1; grid-row:1; }
    #table-A1 { grid-column:2; grid-row:8 / span 2; height:160px; width:80px; align-self:start; } #table-A2 { grid-column:3; grid-row:8 / span 2; height:160px; width:80px; align-self:start; } #table-A3 { grid-column:2 / span 2; grid-row:7; height:50px; } #table-A4 { grid-column:2 / span 2; grid-row:6; height:50px; } #table-A5 { grid-column:2 / span 2; grid-row:5; height:50px; } #table-A6 { grid-column:2 / span 2; grid-row:4; height:50px; } #table-A7 { grid-column:2 / span 2; grid-row:3; height:50px; } #table-A8 { grid-column:2 / span 2; grid-row:2; height:50px; }
    #table-B1 { grid-column:4; grid-row:8; } #table-B2 { grid-column:4; grid-row:7; } #table-B3 { grid-column:4; grid-row:6; } #table-B4 { grid-column:4; grid-row:5; }
  </style>
</head>
<body>
  <header>
    <img src="images/LOGO.png" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô">
    <span>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ ‚Ä¢ ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏≤‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å</span>
  </header>

  <button id="setIpBtn" onclick="openIpModal()"><i class="fa-solid fa-network-wired"></i><div style="text-align:left; line-height:1;"><div style="font-weight:700; font-size:13px;">Set IP</div><small id="ipLabel">192.168.1.100</small></div></button>

  <button id="reportButton" onclick="openReport()"><i class="fa-solid fa-chart-line"></i> ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>

  <div id="ipModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;">
    <div style="background:white;padding:24px;border-radius:16px;width:90%;max-width:400px;box-shadow:0 6px 16px rgba(0,0,0,0.25);">
      <h3 style="margin-top:0;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ IP ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</h3>
      <input type="text" id="printerIpInput" placeholder="192.168.1.100" style="width:100%; padding:8px; margin-bottom:16px; border-radius:8px; border:1px solid #ccc;">
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button onclick="closeIpModal()" style="background:#ccc;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button onclick="saveIp()" style="background:#f59e0b;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
    </div>
  </div>

  <div class="layout" id="tables">
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°1" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°2" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°3" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°4" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°5" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°6" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°7" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°8" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°9" class="table-card"></div>
    <div id="table-‡∏ã‡∏∏‡πâ‡∏°10" class="table-card"></div>
    <div id="table-A1" class="table-card"></div>
    <div id="table-A2" class="table-card"></div>
    <div id="table-A3" class="table-card"></div>
    <div id="table-A4" class="table-card"></div>
    <div id="table-A5" class="table-card"></div>
    <div id="table-A6" class="table-card"></div>
    <div id="table-A7" class="table-card"></div>
    <div id="table-A8" class="table-card"></div>
    <div id="table-B1" class="table-card"></div>
    <div id="table-B2" class="table-card"></div>
    <div id="table-B3" class="table-card"></div>
    <div id="table-B4" class="table-card"></div>
  </div>

  <div id="reportModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
    <div style="background:white;padding:24px;border-radius:16px;width:95%;max-width:900px;max-height:90%;overflow:auto;box-shadow:0 6px 16px rgba(0,0,0,0.25);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2 style="margin:0;color:#d946ef">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</h2>
        <button onclick="closeReport()" style="border:none;background:none;font-size:22px;cursor:pointer;color:#666;">‚úñ</button>
      </div>
      <div style="display:flex;gap:20px;margin-bottom:24px;flex-wrap:wrap;">
        <div style="flex:1;background:#e8fdf2;padding:16px;border-radius:12px;text-align:center;">
          <h3 style="margin:0;color:#24d67a;">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
          <p id="summaryToday" style="margin:0;font-size:18px;font-weight:bold;">0 ‡∏ø</p>
        </div>
        <div style="flex:1;background:#fff4e5;padding:16px;border-radius:12px;text-align:center;">
          <h3 style="margin:0;color:#fb923c;">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
          <p id="summaryMonth" style="margin:0;font-size:18px;font-weight:bold;">0 ‡∏ø</p>
        </div>
        <div style="flex:1;background:#f3e8ff;padding:16px;border-radius:12px;text-align:center;">
          <h3 style="margin:0;color:#a78bfa;">‡∏õ‡∏µ‡∏ô‡∏µ‡πâ</h3>
          <p id="summaryYear" style="margin:0;font-size:18px;font-weight:bold;">0 ‡∏ø</p>
        </div>
      </div>
      <canvas id="salesChart" height="200"></canvas>

      <h3 style="margin-top:24px;color:#333;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ö‡∏¥‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
      <table id="historyTable" border="1" style="width:100%;border-collapse:collapse;text-align:center;">
        <thead>
          <tr style="background:#f3f4f6;">
            <th>Bill ID</th><th>‡πÇ‡∏ï‡πä‡∏∞</th><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th><th>‡∏û‡∏¥‡∏°‡∏û‡πå</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <button onclick="exportHistoryExcel()" style="margin-top:12px;background:#10b981;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;">Export Excel</button>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- IP Modal ---
    function openIpModal() {
      const modal = document.getElementById('ipModal');
      const input = document.getElementById('printerIpInput');
      const currentIP = localStorage.getItem('PRINTER_IP') || '192.168.1.100';
      input.value = currentIP;
      modal.style.display = 'flex';
    }
    function closeIpModal() { document.getElementById('ipModal').style.display='none'; }
    function saveIp() {
      const ip = document.getElementById('printerIpInput').value.trim();
      if(ip){ localStorage.setItem('PRINTER_IP', ip); document.getElementById('ipLabel').innerText=ip; closeIpModal(); }
    }

    // --- Report Modal ---
    function openReport(){ document.getElementById('reportModal').style.display='flex'; fetchReport(); }
    function closeReport(){ document.getElementById('reportModal').style.display='none'; }

    // --- Fetch Report ---
    async function fetchReport(){
      const [daily, monthly, yearly, history] = await Promise.all([
        supabase.rpc('get_daily_sales'),
        supabase.rpc('get_monthly_sales'),
        supabase.rpc('get_yearly_sales'),
        supabase.from('sales_history').select('*').order('created_at',{ascending:false}).limit(50)
      ]);

      document.getElementById('summaryToday').innerText = (daily.data?.total||0).toLocaleString() + ' ‡∏ø';
      document.getElementById('summaryMonth').innerText = (monthly.data?.total||0).toLocaleString() + ' ‡∏ø';
      document.getElementById('summaryYear').innerText = (yearly.data?.total||0).toLocaleString() + ' ‡∏ø';

      const ctx = document.getElementById('salesChart').getContext('2d');
      if(window.salesChartObj) window.salesChartObj.destroy();
      window.salesChartObj = new Chart(ctx,{type:'line',data:{labels:daily.data?.labels||[],datasets:[{label:'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',data:daily.data?.values||[],borderColor:'#d946ef',backgroundColor:'rgba(220,38,38,0.2)',fill:true,tension:0.4}]}});
      
      const tbody = document.querySelector('#historyTable tbody');
      tbody.innerHTML='';
      history.data.forEach(row=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${row.bill_id}</td><td>${row.table_name}</td><td>${new Date(row.created_at).toLocaleTimeString()}</td><td>${row.total_items}</td><td>${row.total_amount}</td><td><button onclick="printBill('${row.bill_id}')">üñ®</button></td>`;
        tbody.appendChild(tr);
      });
    }

    // --- Export Excel ---
    function exportHistoryExcel(){
      const table=document.getElementById('historyTable');
      const wb=XLSX.utils.table_to_book(table,{sheet:'History'});
      XLSX.writeFile(wb,'History.xlsx');
    }

    // --- Print POS ---
    function printBill(billId){ alert('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•: '+billId); }

    // --- Hybrid Caching & Realtime Table Status ---
    function renderTable(tblData){
        const el = document.getElementById('table-' + tblData.name);
        if (el) {
            el.className = 'table-card ' + (tblData.status === 'free' ? 'free' : 'busy');
            el.innerHTML = `<i class="fa-solid ${tblData.status === 'free' ? 'fa-circle-check' : 'fa-circle-xmark'} status-icon"></i>${tblData.name}`;
        }
    }

    // Load from cache first
    function loadTablesFromCache() {
        const cachedData = sessionStorage.getItem('table_status_cache');
        if (cachedData) {
            const tables = JSON.parse(cachedData);
            tables.forEach(renderTable);
        } else {
            console.log('No cache found. Fetching from Supabase...');
        }
    }

    // Fetch latest data and update cache
    async function fetchAndUpdateTables() {
        const { data, error } = await supabase.from('table_status').select('*');
        if (error) {
            console.error('Error fetching table status:', error.message);
            return;
        }
        if (data) {
            data.forEach(renderTable);
            sessionStorage.setItem('table_status_cache', JSON.stringify(data));
        }
    }
    
    // Setup Realtime Subscription
    supabase.channel('table-updates')
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'table_status' }, (payload) => {
            console.log('Change received!', payload);
            renderTable(payload.new);
            // Invalidate cache on update
            sessionStorage.removeItem('table_status_cache');
        })
        .subscribe();

    // Initial load
    document.addEventListener('DOMContentLoaded', () => {
        loadTablesFromCache();
        fetchAndUpdateTables(); // Fetch latest data in background
        const ip = localStorage.getItem('PRINTER_IP') || '192.168.1.100';
        document.getElementById('ipLabel').innerText = ip;
    });

  </script>
</body>
</html>
