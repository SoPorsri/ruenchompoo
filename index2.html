<!doctype html>
<html lang="th">
<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <title>à¸£à¹‰à¸²à¸™à¹€à¸£à¸·à¸­à¸™à¸Šà¸¡à¸à¸¹à¹€à¸™à¸·à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸à¸²à¸«à¸¥à¸µ - à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</title>
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

Â  <style>
Â  Â  body { font-family: system-ui, "Noto Sans Thai", sans-serif; margin: 0; background-color: #e6fff7; }
Â  Â  header { background: linear-gradient(90deg, #ec4899, #d946ef); color: white; padding: clamp(12px,2vw,16px); text-align:center; font-size:clamp(16px,2.5vw,20px); font-weight:bold; letter-spacing:0.5px; box-shadow:0 2px 8px rgba(0,0,0,0.2); position:relative; }
Â  Â  header img { height:100px; vertical-align:middle; margin-right:8px; }
Â  Â  header span { vertical-align:middle; }

Â  Â  #setIpBtn {
Â  Â  Â  position:absolute; right:clamp(10px,2vw,16px); top:calc(0 + clamp(0px,2vw,16px) + 100px);
Â  Â  Â  background: linear-gradient(135deg, #f59e0b, #d97706); color:#fff; border:none; padding:8px 12px; border-radius:10px;
Â  Â  Â  cursor:pointer; font-size:13px; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.2); display:inline-flex; align-items:center; gap:8px; z-index:300;
Â  Â  }
Â  Â  #setIpBtn i { font-size:14px; }
Â  Â  #setIpBtn small { display:block; font-weight:400; font-size:11px; opacity:0.95; }
Â  Â  #setIpBtn:hover { transform: translateY(-2px); }
Â  Â  @media (max-width:600px){#setIpBtn{padding:6px 10px; font-size:12px; top:calc(0+72px+8px);}}

Â  Â  #reportButton {
Â  Â  Â  position:fixed; bottom:6px; right:6px;
Â  Â  Â  background: linear-gradient(135deg, #FBCFE8,#EC4899,#BE185D); color:#fff; border:none; padding:clamp(8px,1.5vw,12px) clamp(12px,2vw,18px);
Â  Â  Â  border-radius:50px; cursor:pointer; font-size:clamp(12px,1.8vw,14px); font-weight:600; box-shadow:0 6px 20px rgba(190,24,93,0.35);
Â  Â  Â  display:flex; align-items:center; gap:4px; transition:transform 0.2s, box-shadow 0.2s; z-index:100;
Â  Â  }
Â  Â  #reportButton:hover{transform:translateY(-3px) scale(1.05); box-shadow:0 6px 20px rgba(0,0,0,0.35);}
Â  Â  #reportButton i{font-size:clamp(14px,1.8vw,18px);}
Â  Â  @media (max-width:600px){#reportButton{bottom:12px; right:12px; padding:10px 16px; font-size:14px;} #reportButton i{font-size:16px;}}

Â  Â  .layout { display:grid; grid-template-columns:90px 90px 90px 90px; grid-template-rows:repeat(12,60px); gap:12px; padding:24px; justify-content:center; position:relative; z-index:1; }
Â  Â  .table-card { display:flex; align-items:center; justify-content:center; border-radius:10px; font-size:14px; font-weight:600; cursor:pointer; transition:transform 0.2s, box-shadow 0.2s; box-shadow:0 3px 6px rgba(0,0,0,0.1); padding:6px; text-align:center; }
Â  Â  .table-card:hover { transform:translateY(-4px) scale(1.05); box-shadow:0 6px 12px rgba(0,0,0,0.15);}
Â  Â  .free { background: linear-gradient(135deg,#34d399,#10b981); color:white; }
Â  Â  .busy { background: linear-gradient(135deg,#f87171,#ef4444); color:white; }
Â  Â  .status-icon { font-size:18px; margin-right:6px; }
Â  Â  .status-icon.free { color:#bbf7d0; }
Â  Â  .status-icon.busy { color:#fecaca; }

Â  Â  #table-à¸‹à¸¸à¹‰à¸¡1 { grid-column:1; grid-row:10; } #table-à¸‹à¸¸à¹‰à¸¡2 { grid-column:1; grid-row:9; } #table-à¸‹à¸¸à¹‰à¸¡3 { grid-column:1; grid-row:8; } #table-à¸‹à¸¸à¹‰à¸¡4 { grid-column:1; grid-row:7; } #table-à¸‹à¸¸à¹‰à¸¡5 { grid-column:1; grid-row:6; } #table-à¸‹à¸¸à¹‰à¸¡6 { grid-column:1; grid-row:5; } #table-à¸‹à¸¸à¹‰à¸¡7 { grid-column:1; grid-row:4; } #table-à¸‹à¸¸à¹‰à¸¡8 { grid-column:1; grid-row:3; } #table-à¸‹à¸¸à¹‰à¸¡9 { grid-column:1; grid-row:2; } #table-à¸‹à¸¸à¹‰à¸¡10 { grid-column:1; grid-row:1; }
Â  Â  #table-A1 { grid-column:2; grid-row:8 / span 2; height:160px; width:80px; align-self:start; } #table-A2 { grid-column:3; grid-row:8 / span 2; height:160px; width:80px; align-self:start; } #table-A3 { grid-column:2 / span 2; grid-row:7; height:50px; } #table-A4 { grid-column:2 / span 2; grid-row:6; height:50px; } #table-A5 { grid-column:2 / span 2; grid-row:5; height:50px; } #table-A6 { grid-column:2 / span 2; grid-row:4; height:50px; } #table-A7 { grid-column:2 / span 2; grid-row:3; height:50px; } #table-A8 { grid-column:2 / span 2; grid-row:2; height:50px; }
Â  Â  #table-B1 { grid-column:4; grid-row:8; } #table-B2 { grid-column:4; grid-row:7; } #table-B3 { grid-column:4; grid-row:6; } #table-B4 { grid-column:4; grid-row:5; }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <img src="images/LOGO.png" alt="à¹‚à¸¥à¹‚à¸à¹‰à¸£à¹‰à¸²à¸™">
Â  Â  <span>à¸£à¹‰à¸²à¸™à¹€à¸£à¸·à¸­à¸™à¸Šà¸¡à¸à¸¹à¹€à¸™à¸·à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸à¸²à¸«à¸¥à¸µ â€¢ à¸ªà¸²à¸‚à¸²à¸™à¸²à¹€à¸Šà¸·à¸­à¸</span>
Â  </header>

Â  <button id="setIpBtn"><i class="fa-solid fa-network-wired"></i><div style="text-align:left; line-height:1;"><div style="font-weight:700; font-size:13px;">Set IP</div><small id="ipLabel">192.168.1.100</small></div></button>

Â  <button id="reportButton"><i class="fa-solid fa-chart-line"></i> à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™</button>

Â  <div id="ipModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:1000;">
Â  Â  <div style="background:white;padding:24px;border-radius:16px;width:90%;max-width:400px;box-shadow:0 6px 16px rgba(0,0,0,0.25);">
Â  Â  Â  <h3 style="margin-top:0;">à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² IP à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œ</h3>
Â  Â  Â  <input type="text" id="printerIpInput" placeholder="192.168.1.100" style="width:100%; padding:8px; margin-bottom:16px; border-radius:8px; border:1px solid #ccc;">
Â  Â  Â  <div style="display:flex;justify-content:flex-end;gap:8px;">
Â  Â  Â  Â  <button id="closeIpBtn" style="background:#ccc;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  Â  Â  Â  <button id="saveIpBtn" style="background:#f59e0b;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;">à¸šà¸±à¸™à¸—à¸¶à¸</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div class="layout" id="tables">
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡1" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡2" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡3" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡4" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡5" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡6" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡7" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡8" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡9" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡10" class="table-card"></div>
Â  Â  <div id="table-A1" class="table-card"></div>
Â  Â  <div id="table-A2" class="table-card"></div>
Â  Â  <div id="table-A3" class="table-card"></div>
Â  Â  <div id="table-A4" class="table-card"></div>
Â  Â  <div id="table-A5" class="table-card"></div>
Â  Â  <div id="table-A6" class="table-card"></div>
Â  Â  <div id="table-A7" class="table-card"></div>
Â  Â  <div id="table-A8" class="table-card"></div>
Â  Â  <div id="table-B1" class="table-card"></div>
Â  Â  <div id="table-B2" class="table-card"></div>
Â  Â  <div id="table-B3" class="table-card"></div>
Â  Â  <div id="table-B4" class="table-card"></div>
Â  </div>

Â  <div id="reportModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;justify-content:center;align-items:center;">
Â  Â  <div style="background:white;padding:24px;border-radius:16px;width:95%;max-width:900px;max-height:90%;overflow:auto;box-shadow:0 6px 16px rgba(0,0,0,0.25);">
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
Â  Â  Â  Â  <h2 style="margin:0;color:#d946ef">ğŸ“Š à¸£à¸²à¸¢à¸‡à¸²à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢</h2>
Â  Â  Â  Â  <button id="closeReportBtn" style="border:none;background:none;font-size:22px;cursor:pointer;color:#666;">âœ–</button>
Â  Â  Â  </div>
Â  Â  Â  <div style="display:flex;gap:20px;margin-bottom:24px;flex-wrap:wrap;">
Â  Â  Â  Â  <div style="flex:1;background:#e8fdf2;padding:16px;border-radius:12px;text-align:center;">
Â  Â  Â  Â  Â  <h3 style="margin:0;color:#24d67a;">à¸§à¸±à¸™à¸™à¸µà¹‰</h3>
Â  Â  Â  Â  Â  <p id="summaryToday" style="margin:0;font-size:18px;font-weight:bold;">0 à¸¿</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="flex:1;background:#fff4e5;padding:16px;border-radius:12px;text-align:center;">
Â  Â  Â  Â  Â  <h3 style="margin:0;color:#fb923c;">à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰</h3>
Â  Â  Â  Â  Â  <p id="summaryMonth" style="margin:0;font-size:18px;font-weight:bold;">0 à¸¿</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="flex:1;background:#f3e8ff;padding:16px;border-radius:12px;text-align:center;">
Â  Â  Â  Â  Â  <h3 style="margin:0;color:#a78bfa;">à¸›à¸µà¸™à¸µà¹‰</h3>
Â  Â  Â  Â  Â  <p id="summaryYear" style="margin:0;font-size:18px;font-weight:bold;">0 à¸¿</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  Â  <canvas id="salesChart" height="200"></canvas>

Â  Â  Â  <h3 style="margin-top:24px;color:#333;">à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸šà¸´à¸¥à¸¥à¹ˆà¸²à¸ªà¸¸à¸”</h3>
Â  Â  Â  <table id="historyTable" border="1" style="width:100%;border-collapse:collapse;text-align:center;">
Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  <tr style="background:#f3f4f6;">
Â  Â  Â  Â  Â  Â  <th>Bill ID</th><th>à¹‚à¸•à¹Šà¸°</th><th>à¹€à¸§à¸¥à¸²</th><th>à¸ˆà¸³à¸™à¸§à¸™</th><th>à¸¢à¸­à¸”à¸£à¸§à¸¡</th><th>à¸à¸´à¸¡à¸à¹Œ</th>
Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  </thead>
Â  Â  Â  Â  <tbody></tbody>
Â  Â  Â  </table>
Â  Â  Â  <button id="exportExcelBtn" style="margin-top:12px;background:#10b981;color:white;padding:8px 12px;border:none;border-radius:6px;cursor:pointer;">Export Excel</button>
Â  Â  </div>
Â  </div>

Â  <script type="module">
Â  Â  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
Â  Â Â 
Â  Â  const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
Â  Â  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
Â  Â  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

Â  Â  // --- IP Modal Functions ---
Â  Â  function openIpModal() {
Â  Â  Â  const modal = document.getElementById('ipModal');
Â  Â  Â  const input = document.getElementById('printerIpInput');
Â  Â  Â  const currentIP = localStorage.getItem('PRINTER_IP') || '192.168.1.100';
Â  Â  Â  input.value = currentIP;
Â  Â  Â  modal.style.display = 'flex';
Â  Â  }
Â  Â  function closeIpModal() { document.getElementById('ipModal').style.display='none'; }
Â  Â  function saveIp() {
Â  Â  Â  const ip = document.getElementById('printerIpInput').value.trim();
Â  Â  Â  if(ip){ localStorage.setItem('PRINTER_IP', ip); document.getElementById('ipLabel').innerText=ip; closeIpModal(); }
Â  Â  }

Â  Â  // --- Report Modal Functions ---
Â  Â  function openReport(){Â 
Â  Â  Â  document.getElementById('reportModal').style.display='flex';Â 
Â  Â  Â  fetchReport();Â 
Â  Â  }
Â  Â  function closeReport(){ document.getElementById('reportModal').style.display='none'; }

Â  Â  // --- Fetch Report ---
Â  Â  async function fetchReport(){
Â  Â  Â  const [daily, monthly, yearly, history] = await Promise.all([
Â  Â  Â  Â  supabase.rpc('get_daily_sales'),
Â  Â  Â  Â  supabase.rpc('get_monthly_sales'),
Â  Â  Â  Â  supabase.rpc('get_yearly_sales'),
Â  Â  Â  Â  supabase.from('sales_history').select('*').order('created_at',{ascending:false}).limit(50)
Â  Â  Â  ]);

Â  Â  Â  document.getElementById('summaryToday').innerText = (daily.data?.total||0).toLocaleString() + ' à¸¿';
Â  Â  Â  document.getElementById('summaryMonth').innerText = (monthly.data?.total||0).toLocaleString() + ' à¸¿';
Â  Â  Â  document.getElementById('summaryYear').innerText = (yearly.data?.total||0).toLocaleString() + ' à¸¿';

Â  Â  Â  const ctx = document.getElementById('salesChart').getContext('2d');
Â  Â  Â  if(window.salesChartObj) window.salesChartObj.destroy();
Â  Â  Â  window.salesChartObj = new Chart(ctx,{type:'line',data:{labels:daily.data?.labels||[],datasets:[{label:'à¸¢à¸­à¸”à¸‚à¸²à¸¢',data:daily.data?.values||[],borderColor:'#d946ef',backgroundColor:'rgba(220,38,38,0.2)',fill:true,tension:0.4}]}});
Â  Â  Â Â 
Â  Â  Â  const tbody = document.querySelector('#historyTable tbody');
Â  Â  Â  tbody.innerHTML='';
Â  Â  Â  history.data.forEach(row=>{
Â  Â  Â  Â  const tr=document.createElement('tr');
Â  Â  Â  Â  tr.innerHTML=`<td>${row.bill_id}</td><td>${row.table_name}</td><td>${new Date(row.created_at).toLocaleTimeString()}</td><td>${row.total_items}</td><td>${row.total_amount}</td><td><button onclick="printBill('${row.bill_id}')">ğŸ–¨</button></td>`;
Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  });
Â  Â  }

Â  Â  // --- Export Excel ---
Â  Â  function exportHistoryExcel(){
Â  Â  Â  const table=document.getElementById('historyTable');
Â  Â  Â  const wb=XLSX.utils.table_to_book(table,{sheet:'History'});
Â  Â  Â  XLSX.writeFile(wb,'History.xlsx');
Â  Â  }

Â  Â  // --- Print POS ---
Â  Â  function printBill(billId){ alert('à¹€à¸£à¸µà¸¢à¸à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸à¸´à¸¡à¸à¹Œà¸šà¸´à¸¥: '+billId); }

Â  Â  // --- Hybrid Caching & Realtime Table Status ---
Â  Â  function renderTable(tblData){
Â  Â  Â  Â  const el = document.getElementById('table-' + tblData.name);
Â  Â  Â  Â  if (el) {
Â  Â  Â  Â  Â  Â  el.className = 'table-card ' + (tblData.status === 'free' ? 'free' : 'busy');
Â  Â  Â  Â  Â  Â  el.innerHTML = `<i class="fa-solid ${tblData.status === 'free' ? 'fa-circle-check' : 'fa-circle-xmark'} status-icon"></i>${tblData.name}`;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Load from cache first
Â  Â  function loadTablesFromCache() {
Â  Â  Â  Â  const cachedData = sessionStorage.getItem('table_status_cache');
Â  Â  Â  Â  if (cachedData) {
Â  Â  Â  Â  Â  Â  const tables = JSON.parse(cachedData);
Â  Â  Â  Â  Â  Â  tables.forEach(renderTable);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.log('No cache found. Fetching from Supabase...');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Fetch latest data and update cache
Â  Â  async function fetchAndUpdateTables() {
Â  Â  Â  Â  const { data, error } = await supabase.from('table_status').select('*');
Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  console.error('Error fetching table status:', error.message);
Â  Â  Â  Â  Â  Â  // Render from cache if a network error occurs
Â  Â  Â  Â  Â  Â  loadTablesFromCache();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (data) {
Â  Â  Â  Â  Â  Â  data.forEach(renderTable);
Â  Â  Â  Â  Â  Â  sessionStorage.setItem('table_status_cache', JSON.stringify(data));
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // Setup Realtime Subscription
Â  Â  supabase.channel('table-updates')
Â  Â  Â  Â  .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'table_status' }, (payload) => {
Â  Â  Â  Â  Â  Â  console.log('Change received!', payload);
Â  Â  Â  Â  Â  Â  renderTable(payload.new);
Â  Â  Â  Â  Â  Â  // Invalidate cache on update
Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('table_status_cache');
Â  Â  Â  Â  })
Â  Â  Â  Â  .subscribe();
Â  Â Â 
Â  Â  // --- Event Listeners and Initial Load ---
Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  // Set up button listeners
Â  Â  Â  Â  document.getElementById('setIpBtn').addEventListener('click', openIpModal);
Â  Â  Â  Â  document.getElementById('reportButton').addEventListener('click', openReport);
Â  Â  Â  Â  document.getElementById('closeIpBtn').addEventListener('click', closeIpModal);
Â  Â  Â  Â  document.getElementById('saveIpBtn').addEventListener('click', saveIp);
Â  Â  Â  Â  document.getElementById('closeReportBtn').addEventListener('click', closeReport);
Â  Â  Â  Â  document.getElementById('exportExcelBtn').addEventListener('click', exportHistoryExcel);

Â  Â  Â  Â  // Initial load IP and table status
Â  Â  Â  Â  const ip = localStorage.getItem('PRINTER_IP') || '192.168.1.100';
Â  Â  Â  Â  document.getElementById('ipLabel').innerText = ip;
Â  Â  Â  Â  loadTablesFromCache();
Â  Â  Â  Â  fetchAndUpdateTables(); // Fetch latest data in background
Â  Â  });

Â  </script>
</body>
</html>
