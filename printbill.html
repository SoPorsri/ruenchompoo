<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>พิมพ์บิล</title>
</head>
<body>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const urlParams = new URLSearchParams(window.location.search)
const billId = urlParams.get('bill_id')

// ✅ ฟังก์ชัน format ตัวเลข
function formatNumber(num) {
  return Number(num || 0).toLocaleString('th-TH');
}

if (billId) {
  loadBillFromHistory(billId)
}

async function loadBillFromHistory(billId) {
  // ✅ ดึงข้อมูลบิล
  const { data: bill, error: billError } = await client
    .from('bills')
    .select('*')
    .eq('id', billId)
    .single()

  if (billError || !bill) {
    document.body.innerHTML = "<h3>❌ ไม่พบบิล</h3>"
    console.error("billError:", billError)
    return
  }

  // ✅ ดึง bill_items
  const { data: items, error: itemsError } = await client
    .from('bill_items')
    .select('id, qty, price, total, menu_id')
    .eq('bill_id', billId)

  if (itemsError) {
    console.error("itemsError:", itemsError)
  }

  // ✅ ดึงชื่อเมนู
  let menuNames = {}
  if (items && items.length > 0) {
    const menuIds = items.map(i => i.menu_id).filter(Boolean)
    if (menuIds.length > 0) {
      const { data: menus } = await client
        .from('menu')
        .select('id, name')
        .in('id', menuIds)
      menus?.forEach(m => { menuNames[m.id] = m.name })
    }
  }

  // ✅ ใส่ชื่อเมนูใน items
  bill.items = (items || []).map(i => ({
    ...i,
    menu_name: menuNames[i.menu_id] || "-"
  }))

  // ✅ สร้าง HTML สำหรับพิมพ์
  const html = buildPrintView(bill)

  const printWindow = window.open('', '_blank')
  printWindow.document.write(html)
  printWindow.document.close()
  printWindow.focus()
  printWindow.print()
}

function buildPrintView(bill) {
  const closedText = bill.closed_at 
    ? new Date(bill.closed_at).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' }) 
    : '-'

  let html = `
  <html>
  <head>
    <title>บิลร้านเรือนชมพูเนื้อย่างเกาหลี</title>
    <style>
      @page { size: 58mm auto; margin: 2mm; }
      body { font-family: "Tahoma", "Noto Sans Thai", sans-serif; font-size: 12px; color:#111; }
      h1,h2,h3,p { margin:0; padding:0; }
      .header { text-align:center; margin-bottom:8px; }
      .header h1 { font-size:18px; font-weight:700; }
      .header p { font-size:11px; margin:2px 0; }
      table { width:100%; border-collapse: collapse; margin-top:4px; }
      th { font-size:11px; font-weight:700; text-align:left; border-bottom:1px dashed #000; padding-bottom:2px; }
      td { padding:2px 0; font-size:12px; }
      td.right, th.right { text-align:right; }
      td.center, th.center {text-align: center;}
      .summary { margin-top:6px; width:100%; }
      .summary div { display:flex; justify-content:space-between; padding:2px 0; font-size:12px; }
      .line-double {border-top:1px dashed #000;margin:4px 0 2px 0;position: relative;}
      .line-double::after {content: "";display: block;border-top:1px dashed #000;margin-top:2px;}
      .big { font-weight:700; font-size:15px; }
      .footer { text-align:center; margin-top:8px; font-size:11px; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>ร้านเรือนชมพูเนื้อย่างเกาหลี</h1>
      <p>สาขานาเชือก</p>
      <p>โทร: 0885305228, 0621392902</p>
      <p>บิลเลขที่: ${bill.billno}</p>
      <p>โต๊ะ/ลูกค้า: ${bill.customer || '-'}</p>
      <p>เวลาเช็คบิล: ${closedText}</p>
    </div>
    <table>
      <thead>
        <tr>
          <th>สินค้า</th>
          <th class="right">ราคา</th>
          <th class="center">จำนวน</th>
          <th class="right">รวม</th>
        </tr>
      </thead>
      <tbody>
  `

  // ✅ รายการสินค้า
  if (bill.items.length === 0) {
    html += `<tr><td colspan="4" style="text-align:center">ไม่มีรายการ</td></tr>`
  } else {
    bill.items.forEach(item => {
      html += `<tr>
        <td>${item.menu_name}</td>
        <td class="right">${formatNumber(item.price)}</td>
        <td class="center">${formatNumber(item.qty)}</td>
        <td class="right">${formatNumber(item.total)}</td>
      </tr>`
    })
  }

  const total = Number(bill.total || 0)
  const cash = Number(bill.cash || 0)
  const change = Number(bill.change || 0)

  html += `</tbody></table>
    <div class="summary">
      <div class="line-double"></div>
      <div><span>ยอดรวม</span><span class="big">${formatNumber(total)}</span></div>
      <div><span>รับเงินมา</span><span>${formatNumber(cash)}</span></div>
      <div><span>เงินทอน</span><span>${formatNumber(change)}</span></div>
    </div>
    <div class="footer">
      *** ขอบคุณที่อุดหนุน ***
    </div>
  </body>
  </html>
  `
  return html
}
</script>
</body>
</html>
