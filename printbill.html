<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•</title>
</head>
<body>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const urlParams = new URLSearchParams(window.location.search)
const billId = urlParams.get('bill_id')

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô format ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
function formatNumber(num) {
  return Number(num || 0).toLocaleString('th-TH');
}

if (billId) {
  loadBillFromHistory(billId)
}

async function loadBillFromHistory(billId) {
    // ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏•‡πÅ‡∏•‡∏∞ items (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    // ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• bill, items, menuNames ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) ...
    
    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏¥‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const { data: bill, error: billError } = await client
        .from('bills')
        .select('*')
        .eq('id', billId)
        .single()

    if (billError || !bill) {
        document.body.innerHTML = "<h3>‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏¥‡∏•</h3>"
        console.error("billError:", billError)
        return
    }

    // ‚úÖ ‡∏î‡∏∂‡∏á bill_items (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const { data: items, error: itemsError } = await client
        .from('bill_items')
        .select('id, qty, price, total, menu_id')
        .eq('bill_id', billId)

    if (itemsError) {
        console.error("itemsError:", itemsError)
    }

    // ‚úÖ ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    let menuNames = {}
    if (items && items.length > 0) {
        const menuIds = items.map(i => i.menu_id).filter(Boolean)
        if (menuIds.length > 0) {
            const { data: menus } = await client
                .from('menu')
                .select('id, name')
                .in('id', menuIds)
            menus?.forEach(m => { menuNames[m.id] = m.name })
        }
    }

    // ‚úÖ ‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏ô items (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    bill.items = (items || []).map(i => ({
        ...i,
        menu_name: menuNames[i.menu_id] || "-"
    }))

    // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏°‡∏û‡πå (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
    const html = buildPrintView(bill)

    // 1. ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô HTML ‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    document.body.innerHTML = html;
    // 2. (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á *‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å* ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏™‡∏£‡πá‡∏à
    window.onafterprint = () => {
        window.close();
    };
    // 3. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÉ‡∏ô HTML ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ
    const logoImg = document.querySelector('.header img');
    // 4. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå
    const triggerPrint = () => {
        window.print();
    };
    if (logoImg) {
        // 5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏£‡∏π‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏¢‡∏±‡∏á (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡∏à‡∏≤‡∏Å cache)
        if (logoImg.complete) {
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß -> ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏¢
            triggerPrint();
        } else {
            // 6. ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à -> ‡πÉ‡∏´‡πâ‡∏£‡∏≠ "onload" (‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)
            logoImg.onload = triggerPrint;
            
            // 7. (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç) ‡πÉ‡∏´‡πâ‡∏£‡∏≠ "onerror" (‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß) ‡∏î‡πâ‡∏ß‡∏¢
            logoImg.onerror = () => {
                console.error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÑ‡∏î‡πâ, ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ');
                triggerPrint(); // ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏°‡πâ‡∏£‡∏π‡∏õ‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô
            };
        }
    } else {
        // 8. ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡πÅ‡∏ó‡πá‡∏Å <img> ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î HTML ‡∏ú‡∏¥‡∏î)
        // ‡∏Å‡πá‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
        triggerPrint();
    }
}

function buildPrintView(bill) {
  const closedText = bill.closed_at 
    ? new Date(bill.closed_at).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' }) 
    : '-'

  let html = `
  <html>
  <head>
    <title>‡∏ö‡∏¥‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</title>
    <style>
      @page { size: 58mm auto; margin: 1mm; }
      body { font-family: "Tahoma", "Noto Sans Thai", sans-serif; font-size: 14px; color:#111; }
      h1,h2,h3,p { margin:0; padding:0; }
      .header { text-align:center; margin-bottom:8px; }
      /* --- üí° 1. ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏•‡πÇ‡∏Å‡πâ --- */
      .header img {
        width: 80px; /* <-- ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ */
        height: auto;
        margin-bottom: 4px;
        filter: grayscale(100%);
      }
      /* ------------------------------ */
      .header h1 { font-size:18px; font-weight:700; }
      .header p { font-size:11px; margin:2px 0; }
      table { width:100%; border-collapse: collapse; margin-top:4px; }
      th { font-size:11px; font-weight:700; text-align:left; border-bottom:1px dashed #000; padding-bottom:2px; }
      td { padding:2px 0; font-size:12px; }
      td.right, th.right { text-align:right; }
      td.center, th.center {text-align: center;}
      .summary { margin-top:6px; width:100%; }
      .summary div { display:flex; justify-content:space-between; padding:2px 0; font-size:12px; }
      .line-double {border-top:1px dashed #000;margin:4px 0 2px 0;position: relative;}
      .line-double::after {content: "";display: block;border-top:1px dashed #000;margin-top:2px;}
      .big { font-weight:700; font-size:18px; }
      .fm { font-weight:700; font-size:16px; }
      .footer { text-align:center; margin-top:8px; font-size:11px; }
    </style>
  </head>
  <body>
    <div class="header">
      <img src="https://raw.githubusercontent.com/SoPorsri/ruenchompoo/main/images/LOGO.png" alt="Logo">
      <h1>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</h1>
      <p>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏≤‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å</p>
      <p>‡πÇ‡∏ó‡∏£: 0885305228, 0621392902</p>
      <p>‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${bill.billno}</p>
      <p>‡πÇ‡∏ï‡πä‡∏∞/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${bill.customer || '-'}</p>
      <p>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ‡∏ö‡∏¥‡∏•: ${closedText}</p>
    </div>
    <table>
      <thead>
        <tr>
          <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
          <th class="center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th class="right">‡∏£‡∏ß‡∏°</th>
        </tr>
      </thead>
      <tbody>
  `

  // ‚úÖ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  if (bill.items.length === 0) {
    html += `<tr><td colspan="4" style="text-align:center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td></tr>`
  } else {
    bill.items.forEach(item => {
      html += `<tr>
        <td>${item.menu_name}</td>
        <td class="right">${formatNumber(item.price)}</td>
        <td class="center">${formatNumber(item.qty)}</td>
        <td class="right">${formatNumber(item.total)}</td>
      </tr>`
    })
  }

  const total = Number(bill.total || 0)
  const cash = Number(bill.cash || 0)
  const change = Number(bill.change || 0)

  html += `</tbody></table>
    <div class="summary">
      <div class="line-double"></div>
      <div><span class="fm">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="big">${formatNumber(total)} ‡∏ö‡∏≤‡∏ó</span></div>
      <div><span class="fm">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</span><span class="fm">${formatNumber(cash)} ‡∏ö‡∏≤‡∏ó</span></div>
      <div><span class="fm">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span><span class="fm">${formatNumber(change)} ‡∏ö‡∏≤‡∏ó</span></div>
    </div>
    <div class="footer">
      *** ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô ***
    </div>
  </body>
  </html>
  `
  return html
}
</script>
</body>
</html>
