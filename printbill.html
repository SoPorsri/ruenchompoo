<!doctype html>
<html lang="th">
<head>
Â  <meta charset="utf-8">
Â  <title>à¸à¸´à¸¡à¸à¹Œà¸šà¸´à¸¥</title>
</head>
<body>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const urlParams = new URLSearchParams(window.location.search)
const billId = urlParams.get('bill_id')

if (billId) {
Â  loadBillFromHistory(billId)
}

async function loadBillFromHistory(billId) {
Â  // âœ… à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸šà¸´à¸¥
Â  const { data: bill, error: billError } = await client
Â  Â  .from('bills')
Â  Â  .select('*')
Â  Â  .eq('id', billId)
Â  Â  .single()

Â  if (billError || !bill) {
Â  Â  document.body.innerHTML = "<h3>âŒ à¹„à¸¡à¹ˆà¸à¸šà¸šà¸´à¸¥</h3>"
Â  Â  console.error("billError:", billError)
Â  Â  return
Â  }

Â  // âœ… à¸”à¸¶à¸‡ bill_items (à¹„à¸¡à¹ˆ join menu)
Â  const { data: items, error: itemsError } = await client
Â  Â  .from('bill_items')
Â  Â  .select('id, qty, price, total, menu_id')
Â  Â  .eq('bill_id', billId)

Â  if (itemsError) {
Â  Â  console.error("itemsError:", itemsError)
Â  }

Â  // âœ… à¸”à¸¶à¸‡à¸Šà¸·à¹ˆà¸­à¹€à¸¡à¸™à¸¹à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡
Â  let menuNames = {}
Â  if (items && items.length > 0) {
Â  Â  const menuIds = items.map(i => i.menu_id).filter(Boolean)
Â  Â  if (menuIds.length > 0) {
Â  Â  Â  const { data: menus } = await client
Â  Â  Â  Â  .from('menu')
Â  Â  Â  Â  .select('id, name')
Â  Â  Â  Â  .in('id', menuIds)
Â  Â  Â  menus?.forEach(m => { menuNames[m.id] = m.name })
Â  Â  }
Â  }

Â  // âœ… à¸œà¸¹à¸à¸Šà¸·à¹ˆà¸­à¹€à¸¡à¸™à¸¹à¸à¸¥à¸±à¸šà¹„à¸›à¸—à¸µà¹ˆ items
Â  bill.items = (items || []).map(i => ({
Â  Â  ...i,
Â  Â  menu_name: menuNames[i.menu_id] || "-"
Â  }))

Â  console.log("âœ… items with menu:", bill.items)

Â  // âœ… à¸ªà¸£à¹‰à¸²à¸‡ HTML à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸´à¸¡à¸à¹Œ
Â  const html = buildPrintView(bill)

Â  const printWindow = window.open('', '_blank')
Â  printWindow.document.write(html)
Â  printWindow.document.close()
Â  printWindow.focus()
Â  printWindow.print()
}

function buildPrintView(bill) {
Â  const closedText = bill.closed_atÂ 
Â  Â  ? new Date(bill.closed_at).toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' })Â 
Â  Â  : '-'

Â  let html = `
Â  <html>
Â  <head>
Â  Â  <title>à¸šà¸´à¸¥à¸£à¹‰à¸²à¸™à¹€à¸£à¸·à¸­à¸™à¸Šà¸¡à¸à¸¹à¹€à¸™à¸·à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸à¸²à¸«à¸¥à¸µ</title>
Â  Â  <style>
Â  Â  Â  @page { size: 58mm auto; margin: 4mm; } /* ğŸ’¡ à¹à¸à¹‰à¹€à¸›à¹‡à¸™ 58mm */
Â  Â  Â  body { font-family: "Tahoma", "Noto Sans Thai", sans-serif; font-size: 12px; color:#111; }
Â  Â  Â  h1,h2,h3,p { margin:0; padding:0; }
Â  Â  Â  .header { text-align:center; margin-bottom:8px; }
Â  Â  Â  .header h1 { font-size:18px; font-weight:700; }
Â  Â  Â  .header p { font-size:11px; margin:2px 0; }
Â  Â  Â  table { width:100%; border-collapse: collapse; margin-top:4px; }
Â  Â  Â  th { font-size:11px; font-weight:700; text-align:left; border-bottom:1px dashed #000; padding-bottom:2px; }
Â  Â  Â  td { padding:2px 0; font-size:12px; }
Â  Â  Â  td.right, th.right { text-align:right; }
Â  Â  Â  /* ğŸ¯ à¸Šà¹ˆà¸­à¸‡à¹„à¸Ÿà¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡à¸ˆà¸³à¸™à¸§à¸™à¸à¸±à¸šà¸¢à¸­à¸”à¸£à¸§à¸¡ */
Â  Â  Â  .item-qty { width: 10%; } 
Â  Â  Â  .item-total { padding-left: 8px; } /* ğŸ’¡ à¸›à¸£à¸±à¸š padding à¹€à¸›à¹‡à¸™ 8px à¹ƒà¸«à¹‰à¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸à¸±à¸š 58mm */
Â  Â  Â  /* -------------------------------------- */
Â  Â  Â  .summary { margin-top:6px; width:100%; }
Â  Â  Â  .summary div { display:flex; justify-content:space-between; padding:2px 0; font-size:12px; }
Â  Â  Â  .line-double {border-top:1px dashed #000;margin:4px 0 2px 0;position: relative;}
Â  Â  Â  .line-double::after {content: "";display: block;border-top:1px dashed #000;margin-top:2px;}
Â  Â  Â  .big { font-weight:700; font-size:15px; }
Â  Â  Â  .footer { text-align:center; margin-top:8px; font-size:11px; }
Â  Â  </style>
Â  </head>
Â  <body>
Â  Â  <div class="header">
Â  Â  Â  <h1>à¸£à¹‰à¸²à¸™à¹€à¸£à¸·à¸­à¸™à¸Šà¸¡à¸à¸¹à¹€à¸™à¸·à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸à¸²à¸«à¸¥à¸µ</h1>
Â  Â  Â  <p>à¸ªà¸²à¸‚à¸²à¸™à¸²à¹€à¸Šà¸·à¸­à¸</p>
Â  Â  Â  <p>à¹‚à¸—à¸£: 0885305228, 0621392902</p>
Â  Â  Â  <p>à¸šà¸´à¸¥à¹€à¸¥à¸‚à¸—à¸µà¹ˆ: ${bill.billno}</p>
Â  Â  Â  <p>à¹‚à¸•à¹Šà¸°/à¸¥à¸¹à¸à¸„à¹‰à¸²: ${bill.customer || '-'}</p>
Â  Â  Â  <p>à¹€à¸§à¸¥à¸²à¹€à¸Šà¹‡à¸„à¸šà¸´à¸¥: ${closedText}</p>
Â  Â  </div>
Â  Â  <table>
Â  Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  <th>à¸ªà¸´à¸™à¸„à¹‰à¸²</th>
Â  Â  Â  Â  Â  <th class="right">à¸£à¸²à¸„à¸²</th>
Â  Â  Â  Â  Â  <th class="right item-qty">à¸ˆà¸³à¸™à¸§à¸™</th>
Â  Â  Â  Â  Â  <th class="right item-total">à¸£à¸§à¸¡</th>
Â  Â  Â  Â  </tr>
Â  Â  Â  </thead>
Â  Â  Â  <tbody>
Â  `

Â  // âœ… à¹à¸ªà¸”à¸‡à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²
Â  if (bill.items.length === 0) {
Â  Â  html += `<tr><td colspan="4" style="text-align:center">à¹„à¸¡à¹ˆà¸¡à¸µà¸£à¸²à¸¢à¸à¸²à¸£</td></tr>`
Â  } else {
Â  Â  bill.items.forEach(item => {
Â  Â  Â  html += `<tr>
Â  Â  Â  Â  <td>${item.menu_name}</td>
Â  Â  Â  Â  <td class="right">${Number(item.price).toFixed(2)}</td>
Â  Â  Â  Â  <td class="right item-qty">${item.qty}</td>
Â  Â  Â  Â  <td class="right item-total">${Number(item.total).toFixed(2)}</td>
Â  Â  Â  </tr>`
Â  Â  })
Â  }

Â  const total = Number(bill.total || 0)
Â  const cash = Number(bill.cash || 0)
Â  const change = Number(bill.change || 0)

Â  html += `</tbody></table>
Â  Â  <div class="summary">
Â  Â  Â  <div class="line-double"></div>
Â  Â  Â  <div><span>à¸¢à¸­à¸”à¸£à¸§à¸¡</span><span class="big">${total.toFixed(2)}</span></div>
Â  Â  Â  <div><span>à¸£à¸±à¸šà¹€à¸‡à¸´à¸™à¸¡à¸²</span><span>${cash.toFixed(2)}</span></div>
Â  Â  Â  <div><span>à¹€à¸‡à¸´à¸™à¸—à¸­à¸™</span><span>${change.toFixed(2)}</span></div>
Â  Â  </div>
Â  Â  <div class="footer">
Â  Â  Â  *** à¸‚à¸­à¸šà¸„à¸¸à¸“à¸—à¸µà¹ˆà¸­à¸¸à¸”à¸«à¸™à¸¸à¸™ ***
Â  Â  </div>
Â  </body>
Â  </html>
Â  `
Â  return html
}
</script>
</body>
</html>
