<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ - ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
<style>
:root{--bg:#f8fafc;--card:#ffffff;--ink:#0f172a;--muted:#475569;--accent:#10b981;--line:#e2e8f0;--danger:#ef4444;}
body{margin:0;font-family:system-ui,"Noto Sans Thai",sans-serif;background:var(--bg);color:var(--ink);}
.container{max-width:1000px;margin:24px auto;padding:16px;}
.app{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(2,8,23,.05);}
header{padding:20px 24px;border-bottom:1px solid var(--line);display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
header h1{margin:0;font-size:clamp(18px,2.6vw,24px);}
.brand{display:flex;flex-direction:column}
.brand .shop{font-weight:800;color:#111827}
.brand .branch{color:var(--muted);font-size:.95em}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button{appearance:none;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;background:var(--ink);color:white;font-weight:600;display:inline-flex;align-items:center;gap:4px;font-size:14px;}
button.accent{background:var(--accent)}
button.secondary{background:#334155}
button.warn{background:var(--danger)}
button.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
.icon{width:16px;height:16px;display:inline-block;vertical-align:middle;}
main{display:grid;grid-template-columns:1.2fr .8fr;gap:0;}
@media(max-width:860px){main{grid-template-columns:1fr;}}
.panel{padding:20px 24px;}
.panel+.panel{border-left:1px solid var(--line);}
@media(max-width:860px){.panel+.panel{border-left:none;border-top:1px solid var(--line);}}
.grid{display:grid;grid-template-columns:1fr 100px 100px 60px;gap:10px;align-items:center}
.grid.header{font-weight:700;border-bottom:1px solid var(--line);padding-bottom:6px;margin-bottom:8px}
.row{padding:6px 0;border-bottom:1px dashed var(--line);cursor:move;}
.muted{color:var(--muted)}
.right{text-align:right}
.num{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid var(--line);border-radius:8px;font-size:14px}
.num[readonly]{background:#f5f7fb}
</style>
</head>
<body>
<div class="container">
  <div class="app">
    <header>
      <div class="brand">
        <div class="shop">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</div>
        <div class="branch">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏≤‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å ‚Ä¢ <small id="today"></small></div>
      </div>
      <div class="controls noprint">
        <button class="accent" id="btnAddMenu">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
      </div>
    </header>

    <main>
      <section class="panel" id="left">
        <h2 style="margin:0 0 10px 0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏ô‡∏π</h2>
        <div class="grid header"><div>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><div class="right">‡∏£‡∏≤‡∏Ñ‡∏≤</div><div class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div><div></div></div>
        <div id="menuItems"></div>
      </section>
    </main>
  </div>
</div>

<!-- popup ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π -->
<div id="popup" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;">
  <div style="background:white;padding:20px;border-radius:12px;width:300px">
    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</h3>
    <input type="text" id="newMenuName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π" style="width:100%;margin-bottom:10px;padding:8px;">
    <input type="number" id="newMenuPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" style="width:100%;margin-bottom:10px;padding:8px;">
    <button id="btnAddMenuConfirm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="btnAddMenuCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const el = id=>document.getElementById(id);
let dragSrcEl = null;

// ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π
async function loadMenu(){
  const { data, error } = await client.from('menu').select('*').order('sort_order');
  if(error){ console.log(error); return; }
  const container = el('menuItems'); container.innerHTML='';
  data.forEach(item=>{
    const row=document.createElement('div');
    row.className='row grid';
    row.draggable = true;
    row.dataset.id = item.id;
    row.innerHTML=`<label>${item.name}</label>
      <div class="right muted">‡∏ø${item.price}</div>
      <input class="num" type="text" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">
      <button class="warn btnDelete" data-id="${item.id}">üóëÔ∏è</button>`;
    container.appendChild(row);
  });
  addDnDHandlers();
  addDeleteHandlers();
}

// ‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π
function addDeleteHandlers(){
  document.querySelectorAll('.btnDelete').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(confirm('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
        const id = parseInt(btn.dataset.id);
        const { error } = await client.from('menu').delete().eq('id', id);
        if(error){ alert('‡∏•‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); console.log(error); }
        else { await loadMenu(); }
      }
    });
  });
}

// Drag & Drop
function addDnDHandlers(){
  const rows=document.querySelectorAll('#menuItems .row');
  rows.forEach(row=>{
    row.addEventListener('dragstart',e=>{
      dragSrcEl=row;
      e.dataTransfer.effectAllowed='move';
      e.dataTransfer.setData('text/html',row.outerHTML);
    });
    row.addEventListener('dragover',e=>{
      e.preventDefault();
      e.dataTransfer.dropEffect='move';
    });
    row.addEventListener('drop',e=>{
      e.stopPropagation();
      if(dragSrcEl!==row){
        dragSrcEl.parentNode.removeChild(dragSrcEl);
        const dropHTML=e.dataTransfer.getData('text/html');
        row.insertAdjacentHTML('beforebegin',dropHTML);
        addDnDHandlers();
        addDeleteHandlers();
        saveMenuOrder();
      }
    });
  });
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π
async function saveMenuOrder(){
  const rows=document.querySelectorAll('#menuItems .row');
  for(let i=0;i<rows.length;i++){
    const id=parseInt(rows[i].dataset.id);
    const { error } = await client.from('menu').update({ sort_order:i }).eq('id', id);
    if(error) console.log('update error', error);
  }
}

// ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà
el('btnAddMenu').addEventListener('click',()=>{ el('popup').style.display='flex'; });
el('btnAddMenuCancel').addEventListener('click',()=>{ el('popup').style.display='none'; });
el('btnAddMenuConfirm').addEventListener('click',async()=>{
  const name=el('newMenuName').value.trim();
  const price=parseFloat(el('newMenuPrice').value);
  if(!name || isNaN(price)){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  const { error } = await client.from('menu').insert([{ name, price }]);
  if(error){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); console.log(error); }
  else { el('popup').style.display='none'; el('newMenuName').value=''; el('newMenuPrice').value=''; loadMenu(); }
});

// init
window.addEventListener('DOMContentLoaded',()=>{
  el('today').textContent=new Date().toLocaleString('th-TH');
  loadMenu();
});
</script>
</body>
</html>
