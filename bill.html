<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ออกบิลร้านเรือนชมพูเนื้อย่างเกาหลี</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#f8fafc;color:#111827}
    .container{max-width:1000px;margin:24px auto;padding:16px}
    .app{background:#fff;border:1px solid #e2e8f0;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.05)}
    header{padding:16px 20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;flex-wrap:wrap}
    header h1{margin:0;font-size:20px}
    header small{color:#64748b}
    button{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    button.accent{background:#10b981;color:#fff}
    button.warn{background:#ef4444;color:#fff}
    button.secondary{background:#334155;color:#fff}
    main{display:grid;grid-template-columns:1.2fr .8fr}
    @media(max-width:860px){main{grid-template-columns:1fr}}
    .panel{padding:20px}
    .panel+.panel{border-left:1px solid #e2e8f0}
    .grid{display:grid;grid-template-columns:1fr 100px 100px;gap:10px;align-items:center}
    .grid.header{font-weight:700;border-bottom:1px solid #e2e8f0;padding-bottom:4px;margin-bottom:8px}
    input.num{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:8px;text-align:right}
    .summary{margin-top:16px}
    .line{display:flex;justify-content:space-between;margin:6px 0}
    .big{font-size:22px;font-weight:700}
  </style>
</head>
<body>
<div class="container">
  <div class="app">
    <header>
      <div>
        <h1>ร้านเรือนชมพูเนื้อย่างเกาหลี</h1>
        <small id="today"></small>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="accent" id="btnSave">บันทึกบิล</button>
        <button class="secondary" id="btnNew">เริ่มบิลใหม่</button>
        <button class="warn" id="btnClear">ล้างทั้งหมด</button>
      </div>
    </header>
    <main>
      <!-- ซ้าย -->
      <section class="panel">
        <h2>เมนู</h2>
        <div class="grid header"><div>สินค้า</div><div>ราคา</div><div>จำนวน</div></div>
        <div id="menuList"></div>
      </section>

      <!-- ขวา -->
      <section class="panel">
        <h2>สรุปบิล</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label>ลูกค้า/โต๊ะ</label>
            <input id="customer" class="num" placeholder="โต๊ะ 1">
          </div>
          <div>
            <label>เลขที่บิล</label>
            <input id="billno" class="num" readonly>
          </div>
        </div>
        <div class="summary">
          <div class="line"><span>รวมทั้งหมด</span><span class="big" id="grand">฿0.00</span></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div><label>รับเงิน</label><input id="cash" type="number" class="num"></div>
          <div><label>เงินทอน</label><input id="change" class="num" readonly></div>
        </div>
        <div style="margin-top:10px">
          <label>หมายเหตุ</label>
          <textarea id="note" style="width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:8px"></textarea>
        </div>
      </section>
    </main>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// TODO: เปลี่ยนเป็น URL และ KEY ของโปรเจกต์คุณ
const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';

// ✅ ตั้งชื่อ client ไม่ให้ซ้ำ
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const el = id => document.getElementById(id);
const fmt = n => new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(n||0);

let menuItems = [];

function todayText(){
  const d = new Date();
  return d.toLocaleString('th-TH',{dateStyle:'medium',timeStyle:'short'});
}

function nextBillNo(){
  const key='pink-grill-last-bill';
  let n = parseInt(localStorage.getItem(key)||'0',10)+1;
  localStorage.setItem(key,String(n));
  return String(n).padStart(5,'0');
}

async function loadMenu(){
  const { data, error } = await client.from("menu").select("*").order("id");
  if(error){ alert("โหลดเมนูผิดพลาด"); return; }
  menuItems = data;
  const box = el("menuList");
  box.innerHTML = "";
  data.forEach(m=>{
    const row = document.createElement("div");
    row.className="grid";
    row.innerHTML=`
      <div>${m.name}</div>
      <div style="text-align:right">฿${m.price}</div>
      <input class="num" type="number" id="menu-${m.id}" min="0" step="1" value="0">
    `;
    box.appendChild(row);
  });
  document.querySelectorAll("#menuList input").forEach(i=> i.addEventListener("input",calc));
}

function calc(){
  let total=0;
  menuItems.forEach(m=>{
    const qty=parseFloat(el("menu-"+m.id).value)||0;
    total+=qty*m.price;
  });
  el("grand").textContent=fmt(total);
  const cash=parseFloat(el("cash").value)||0;
  el("change").value = cash>0 ? fmt(Math.max(0,cash-total)):"";
}

async function saveBill(){
  const billData={
    billno: el("billno").value,
    customer: el("customer").value,
    total: parseFloat(el("grand").textContent.replace(/[^\d.]/g,""))||0,
    cash: parseFloat(el("cash").value)||0,
    change: parseFloat(el("change").value.replace(/[^\d.]/g,""))||0,
    note: el("note").value,
    status:"paid"
  };
  const { data: bill, error } = await client.from("bills").insert(billData).select().single();
  if(error){ alert("บันทึกบิลล้มเหลว"); return; }

  // save bill_items
  const items=[];
  menuItems.forEach(m=>{
    const qty=parseFloat(el("menu-"+m.id).value)||0;
    if(qty>0){ items.push({ bill_id: bill.id, menu_id:m.id, qty, price:m.price }); }
  });
  if(items.length>0){
    const { error: e2 } = await client.from("bill_items").insert(items);
    if(e2){ alert("บันทึกรายการไม่สำเร็จ"); return; }
  }
  alert("บันทึกบิลเรียบร้อย");
}

function clearAll(){
  document.querySelectorAll("input").forEach(i=>i.value="");
  document.querySelectorAll("textarea").forEach(t=>t.value="");
  document.querySelectorAll("#menuList input").forEach(i=>i.value=0);
  calc();
}

// init
window.addEventListener("DOMContentLoaded",()=>{
  el("today").textContent=todayText();
  el("billno").value=nextBillNo();
  el("cash").addEventListener("input",calc);
  el("btnSave").addEventListener("click",saveBill);
  el("btnNew").addEventListener("click",()=>{el("billno").value=nextBillNo();clearAll();});
  el("btnClear").addEventListener("click",()=>{if(confirm("ล้างทั้งหมด?"))clearAll();});
  loadMenu();
});
</script>
</body>
</html>
