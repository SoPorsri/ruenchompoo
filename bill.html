<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// TODO: เปลี่ยนเป็น URL และ KEY ของโปรเจกต์คุณ
const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const PRICES = {
  kg: 220, heed: 22, veg: 35, noodle: 20, mush: 20, corn: 10,
  singha: 90, leo: 80, chang: 80, pepsi: 35, ice: 10,
};
const fmt = n => new Intl.NumberFormat('th-TH', { style: 'currency', currency: 'THB' }).format(n || 0);
const el = id => document.getElementById(id);

function safeEval(expr) {
  if (!expr) return 0;
  expr = expr.replace(/\s+/g, "");
  if (!/^[0-9+\-*/.]+$/.test(expr)) return 0;
  try { return Function('"use strict";return (' + expr + ')')(); }
  catch { return 0; }
}

function calc() {
  const kg = safeEval(el('kg').value);
  const heed = safeEval(el('heed').value);
  let meat = kg * PRICES.kg + heed * PRICES.heed;

  const addKeys = ['veg','noodle','mush','corn','singha','leo','chang','pepsi','ice'];
  let addSum = 0;
  addKeys.forEach(k=>{ addSum += safeEval(el(k).value) * PRICES[k]; });

  const grand = meat + addSum;
  el('meatSum').textContent = fmt(meat);
  el('addSum').textContent = fmt(addSum);
  el('grand').textContent = fmt(grand);

  const cash = safeEval(el('cash').value);
  const change = cash - grand;

  if(cash>0){
    if(change < 0){
      el('cash').style.borderColor = 'var(--danger)';
      el('cashWarn').style.display = 'block';
      el('change').value = '';
    } else {
      el('cash').style.borderColor = 'var(--line)';
      el('cashWarn').style.display = 'none';
      el('change').value = fmt(change);
    }
  } else {
    el('cash').style.borderColor = 'var(--line)';
    el('cashWarn').style.display = 'none';
    el('change').value = '';
  }
}

function buildItems() {
  const ids = ['kg','heed','veg','noodle','mush','corn','singha','leo','chang','pepsi','ice'];
  let items = [];
  ids.forEach(id=>{
    const qty = safeEval(el(id).value);
    if(qty>0) items.push({item:id, qty, price:PRICES[id]});
  });
  return items;
}

async function saveBill() {
  const customer = el('customer').value || '';
  const billno = el('billno').value;
  const note = el('note').value || '';
  const items = buildItems();
  if(items.length===0){ alert("❌ กรุณาใส่รายการขาย"); return; }

  const total = items.reduce((sum,it)=>sum+it.qty*it.price,0);
  const cash = safeEval(el('cash').value) || 0;
  const change = cash - total;

  try {
    // บันทึกบิล
    const { data: billData, error: billErr } = await client
      .from('bills')
      .insert([{ billno, customer, total, cash, change, note }])
      .select().single();
    if(billErr) throw billErr;

    // บันทึกรายการขาย
    const billItems = items.map(it=>({ ...it, bill_id: billData.id }));
    const { error: itemsErr } = await client.from('bill_items').insert(billItems);
    if(itemsErr) throw itemsErr;

    alert('✅ บันทึกบิลเรียบร้อยแล้ว');
  } catch(err) {
    alert('❌ เกิดข้อผิดพลาด: '+err.message);
    console.error(err);
  }
}

window.addEventListener('DOMContentLoaded', () => {
  const todayEl = el('today');
  if(todayEl) todayEl.textContent = new Date().toLocaleString('th-TH', { dateStyle:'medium', timeStyle:'short' });

  el('billno').value = nextBillNo();

  // input change
  document.querySelectorAll('input, textarea').forEach(i=> i.addEventListener('input', calc));

  // ปุ่ม
  el('btnPrint').addEventListener('click', () => {
    const w = window.open('', 'PRINT', 'height=600,width=800');
    w.document.write('<html><head><title>พิมพ์บิล</title></head><body>');
    w.document.write(buildPrintView());
    w.document.write('</body></html>');
    w.document.close();
    w.focus();
    w.print();
    w.close();
  });
  el('btnNew').addEventListener('click', ()=>{ 
    el('billno').value = nextBillNo();
    ['kg','heed','veg','noodle','mush','corn','singha','leo','chang','pepsi','ice','cash','note','customer'].forEach(id=>el(id).value=''); 
    calc();
  });
  el('btnSave').addEventListener('click', saveBill);
  el('btnClear').addEventListener('click', ()=>{ 
    if(confirm('ล้างทั้งหมด?')) ['kg','heed','veg','noodle','mush','corn','singha','leo','chang','pepsi','ice','cash','note','customer'].forEach(id=>el(id).value=''); 
    calc(); 
  });

  calc();
});
</script>
