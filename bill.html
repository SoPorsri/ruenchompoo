<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ - ‡∏≠‡∏≠‡∏Å‡∏ö‡∏¥‡∏•</title>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
<style>
:root{
  --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#475569; --accent:#10b981; --line:#e2e8f0; --danger:#ef4444;
}
body{margin:0;font-family:system-ui, "Noto Sans Thai", sans-serif;background:var(--bg);color:var(--ink);}
.container{max-width:1000px;margin:24px auto;padding:16px;}
.app{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(2,8,23,.05);}
header{padding:20px 24px;border-bottom:1px solid var(--line);display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap;}
header h1{margin:0;font-size:clamp(18px, 2.6vw, 24px);}
.brand{display:flex;flex-direction:column}
.brand .shop{font-weight:800;color:#111827}
.brand .branch{color:var(--muted);font-size:.95em}
.controls{display:flex;gap:8px;flex-wrap:wrap}
button{appearance:none;border:none;padding:10px 14px;border-radius:12px;cursor:pointer;background:var(--ink);color:white;font-weight:600;display:flex;align-items:center;gap:4px;}
button.accent{background:var(--accent)}
button.secondary{background:#334155}
button.warn{background:var(--danger)}
button.ghost{background:transparent;color:var(--ink);border:1px solid var(--line)}
.icon{width:16px;height:16px;display:inline-block;vertical-align:middle;}
main{display:grid;grid-template-columns:1.2fr .8fr;gap:0;}
@media (max-width:860px){main{grid-template-columns:1fr;}}
.panel{padding:20px 24px;}
.panel + .panel{border-left:1px solid var(--line);} 
@media (max-width:860px){.panel + .panel{border-left:none;border-top:1px solid var(--line);}}
.grid{display:grid;grid-template-columns:1fr 110px 130px;gap:10px;align-items:center}
.grid.header{font-weight:700;border-bottom:1px solid var(--line);padding-bottom:6px;margin-bottom:8px}
.row{padding:6px 0;border-bottom:1px dashed var(--line)}
.muted{color:var(--muted)}
.right{text-align:right}
.num{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid var(--line);border-radius:10px;font-size:16px}
.num[readonly]{background:#f5f7fb}
.title-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.summary{display:grid;gap:10px}
.summary .line{display:flex;justify-content:space-between;align-items:center}
.big{font-size:28px;font-weight:800}
.note{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px}
.danger-text{color:var(--danger);font-weight:600;margin-top:4px;font-size:.9em}

/* popup ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π */
#popup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
#popup .content { background:white; padding:20px; border-radius:12px; width:300px; }
#popup input { width:100%; margin-bottom:10px; padding:8px; border:1px solid var(--line); border-radius:8px; }
#popup button { width:100%; margin-top:6px; }
@media print{
  body{background:white}
  .container{margin:0;padding:0}
  .app{border:none;box-shadow:none;border-radius:0}
  header .controls,.noprint{display:none !important}
  main{grid-template-columns:1fr}
  .panel + .panel{border:none}
}
</style>
</head>
<body>
<div class="container">
  <div class="app">
    <header>
      <div class="brand">
        <div class="shop">‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</div>
        <div class="branch">‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏≤‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å ‚Ä¢ <small id="today"></small></div>
      </div>
      <div class="controls noprint">
        <button class="accent" id="btnAddMenu"><span class="icon">üìù</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π</button>
        <button class="ghost" id="btnSave"><span class="icon">üíæ</span> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á</button>
        <button class="warn" id="btnClear"><span class="icon">üóëÔ∏è</span> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•</button>
        <button class="secondary" id="btnHome"><span class="icon">üè†</span> ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        <button class="accent" id="btnPrint"><span class="icon">üñ®Ô∏è</span> ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•</button>
      </div>
    </header>

    <main>
      <section class="panel" id="left">
        <div class="title-row"><h2 style="margin:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2><small class="muted">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏°‡∏ô‡∏π</small></div>
        <div class="grid header"><div>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div><div class="right">‡∏£‡∏≤‡∏Ñ‡∏≤</div><div class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</div></div>
        <div id="menuItems"></div>
      </section>

      <section class="panel" id="right">
        <h2 style="margin:0 0 10px 0">‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏¥‡∏•</h2>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
          <div>
            <label class="muted">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤/‡πÇ‡∏ï‡πä‡∏∞</label>
            <input class="num" id="customer" placeholder="‡πÇ‡∏ï‡πä‡∏∞ 3 ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤">
          </div>
          <div>
            <label class="muted">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•</label>
            <input class="num" id="billno" readonly>
          </div>
        </div>
        <div class="summary">
          <div class="line"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="big" id="grand">‡∏ø0.00</span></div>
        </div>
        <div style="margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label class="muted">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤</label>
            <input class="num" id="cash" placeholder="‡πÄ‡∏ä‡πà‡∏ô 500+500">
            <div id="cashWarn" class="danger-text" style="display:none">‚ö†Ô∏è ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏≠</div>
          </div>
          <div>
            <label class="muted">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</label>
            <input class="num" id="change" readonly>
          </div>
        </div>
        <div style="margin-top:10px">
          <label class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
          <textarea class="note" id="note" rows="3" placeholder=""></textarea>
        </div>
      </section>
    </main>
  </div>
</div>

<!-- popup ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π -->
<div id="popup">
  <div class="content">
    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà</h3>
    <input type="text" id="newMenuName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π">
    <input type="number" id="newMenuPrice" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" min="0">
    <button id="btnAddMenuConfirm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button id="btnAddMenuCancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<!-- popup ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏¥‡∏• -->
<div id="billModal" style="display:none; position:fixed; top:0; left:0; 
    width:100%; height:100%; background:rgba(0,0,0,0.5); 
    justify-content:center; align-items:center; z-index:9999;">
  <div class="bill-content" style="background:white; padding:16px; border-radius:12px; 
      width:320px; max-height:90%; overflow:auto; font-family:'Noto Sans Thai',sans-serif;">

    <div id="billContent"></div>

    <button onclick="printBill()" 
      style="margin-top:10px; width:100%; padding:10px; border:none; 
      background:#10b981; color:white; border-radius:8px; font-weight:600;">
      üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•
    </button>
    <button onclick="closeBillModal()" 
      style="margin-top:6px; width:100%; padding:10px; border:none; 
      background:#ef4444; color:white; border-radius:8px; font-weight:600;">
      ‚ùå ‡∏õ‡∏¥‡∏î
    </button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const el=id=>document.getElementById(id);
const fmt=n=>new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB'}).format(n||0);
function safeEval(expr){if(!expr)return 0;expr=expr.replace(/\s+/g,'');if(!/^[0-9+\-*/.]+$/.test(expr))return 0;try{return Function('"use strict";return('+expr+')')();}catch{return 0;}}

function todayText(){const d=new Date();return d.toLocaleString('th-TH',{dateStyle:'medium',timeStyle:'short'});}
function nextBillNo(){const key='pink-grill-last-bill';let n=parseInt(localStorage.getItem(key)||'0',10)+1;localStorage.setItem(key,String(n));return String(n).padStart(5,'0');}

let menuData = [];
const params = new URLSearchParams(window.location.search);
const table_id = params.get('table_id');

async function loadTableName() {
  if (!table_id) return;
  const { data, error } = await client.from('tables').select('*').eq('id', table_id).single();
  if (error) { console.log(error); return; }
  if (data) {
    el('customer').value = data.name;
    const { error:updateError } = await client.from('tables').update({ status: '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á' }).eq('id', table_id);
    if(updateError) console.log('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', updateError);
  }
}

async function loadMenu(){
  const { data, error } = await client.from('menu').select('*').order('id');
  if(error){alert('‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');console.log(error);return;}
  menuData = data;
  const container = el('menuItems'); container.innerHTML='';
  data.forEach(item=>{
    const row=document.createElement('div');
    row.className='row grid';
    row.innerHTML=`<label>${item.name}</label><div class="right muted">‡∏ø${item.price}</div><input class="num" type="text" data-id="${item.id}" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1+2+3">`;
    container.appendChild(row);
  });
  document.querySelectorAll('#menuItems input').forEach(i=>i.addEventListener('input',calc));
}

// ‡πÇ‡∏´‡∏•‡∏î draft ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞
async function loadDraft() {
  if (!table_id) return; 

  // 1Ô∏è‚É£ ‡∏î‡∏∂‡∏á draft ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞
  const { data: draftData, error: draftError } = await client.from('drafts')
    .select('*').eq('table_id', table_id).single();

  if(draftError){ console.log('‡πÇ‡∏´‡∏•‡∏î draft ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', draftError); return; }
  if(!draftData) return;

  el('billno').value = draftData.billno || nextBillNo();
  el('customer').value = draftData.customer || '';
  el('cash').value = draftData.cash || '';
  el('note').value = draftData.note || '';

  // 2Ô∏è‚É£ ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  const { data: items, error: itemsError } = await client.from('draft_items')
    .select('*').eq('draft_id', draftData.id);

  if(itemsError){ console.log('‡πÇ‡∏´‡∏•‡∏î draft_items ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', itemsError); return; }

  items.forEach(item=>{
    const input = document.querySelector(`#menuItems input[data-id="${item.menu_id}"]`);
    if(input) input.value = item.qty;
  });

  calc();
}

function calc(){
  let total=0;
  document.querySelectorAll('#menuItems input').forEach(inp=>{
    const qty=safeEval(inp.value);
    const id=parseInt(inp.dataset.id);
    const menuItem=menuData.find(m=>m.id===id);
    if(menuItem && qty>0) total+=qty*menuItem.price;
  });
  const cash=safeEval(el('cash').value);
  const change=cash-total;
  el('grand').textContent=fmt(total);
  if(cash>0 && change<0){el('cash').style.borderColor='var(--danger)';el('cashWarn').style.display='block';el('change').value='';}
  else{el('cash').style.borderColor='var(--line)';el('cashWarn').style.display='none';el('change').value = fmt(change>0?change:0);}
}

function buildPrintView() {
  const now = new Date();
  const dateText = now.toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' });

  let html = `
  <html>
  <head>
    <title>‡∏ö‡∏¥‡∏•‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</title>
    <style>
      body { font-family: "Noto Sans Thai", sans-serif; margin:20px; color:#111; }
      h1,h2,h3 { margin:0; padding:0; }
      .header { text-align:center; margin-bottom:12px; }
      .header h1 { font-size:24px; }
      .header p { font-size:14px; margin:2px 0; }
      table { width:100%; border-collapse: collapse; margin-top:10px; }
      table, th, td { border:1px solid #000; }
      th, td { padding:6px 8px; text-align:left; }
      th.right, td.right { text-align:right; }
      .summary { margin-top:12px; width:100%; display:grid; grid-template-columns:1fr auto; }
      .summary div { padding:4px 0; }
      .big { font-weight:800; font-size:20px; }
      .note { margin-top:8px; font-size:14px; }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</h1>
      <p>‡∏™‡∏≤‡∏Ç‡∏≤‡∏ô‡∏≤‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å</p>
      <p>‡πÇ‡∏ó‡∏£: 099-9999999</p>
      <p>‡∏ö‡∏¥‡∏•‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà: ${el('billno').value}</p>
      <p>‡πÇ‡∏ï‡πä‡∏∞/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${el('customer').value}</p>
      <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateText}</p>
    </div>
    <table>
      <thead>
        <tr>
          <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
          <th class="right">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
          <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
          <th class="right">‡∏£‡∏ß‡∏°</th>
        </tr>
      </thead>
      <tbody>
  `;

  document.querySelectorAll('#menuItems input').forEach(inp => {
    const qty = safeEval(inp.value);
    if (qty <= 0) return;
    const menu_id = parseInt(inp.dataset.id);
    const menuItem = menuData.find(m => m.id === menu_id);
    if (menuItem) {
      html += `<tr>
        <td>${menuItem.name}</td>
        <td class="right">${menuItem.price.toFixed(2)}</td>
        <td class="right">${qty}</td>
        <td class="right">${(qty * menuItem.price).toFixed(2)}</td>
      </tr>`;
    }
  });

  const total = safeEval(el('grand').textContent.replace(/[^\d.]/g,''));
  const cash = safeEval(el('cash').value);
  const change = safeEval(el('change').value);

  html += `</tbody></table>
    <div class="summary">
      <div>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</div><div class="right big">${total.toFixed(2)}</div>
      <div>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏≤</div><div class="right">${cash.toFixed(2)}</div>
      <div>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</div><div class="right">${change.toFixed(2)}</div>
    </div>
    <div class="note">
      ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${el('note').value || '-'}
    </div>
    <p style="text-align:center; margin-top:20px; font-size:12px;">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏ä‡∏°‡∏û‡∏π‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</p>
  </body>
  </html>
  `;
  return html;
}


async function saveDraft() {
  const billno = el('billno').value || nextBillNo();
  const customer = el('customer').value;
  const total = safeEval(el('grand').textContent.replace(/[^\d.]/g,''));
  const cash = safeEval(el('cash').value);
  const change = safeEval(el('change').value);
  const note = el('note').value;

  try {
    // 1Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ draft ‡πÄ‡∏î‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    let { data: existingDraft } = await client.from('drafts')
      .select('*')
      .eq('billno', billno)
      .single();

    let draftId;
    if (existingDraft) {
      // update draft
      const { data: updatedDraft, error: updateError } = await client.from('drafts')
        .update({ customer, table_id, total, cash, change, note, updated_at: new Date().toISOString() })
        .eq('id', existingDraft.id)
        .select()
        .single();
      if(updateError) throw updateError;
      draftId = updatedDraft.id;
    } else {
      // insert draft ‡πÉ‡∏´‡∏°‡πà
      const { data: newDraft, error: insertError } = await client.from('drafts')
        .insert([{ billno, customer, table_id, total, cash, change, note }])
        .select()
        .single();
      if(insertError) throw insertError;
      draftId = newDraft.id;
    }

    // 2Ô∏è‚É£ ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤‡πÉ‡∏ô draft_items
    await client.from('draft_items').delete().eq('draft_id', draftId);

    // 3Ô∏è‚É£ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
    const items = [];
    document.querySelectorAll('#menuItems input').forEach(inp => {
      const qty = safeEval(inp.value);
      if (qty > 0) items.push({
        draft_id: draftId,
        menu_id: parseInt(inp.dataset.id),
        qty
      });
    });

    // 4Ô∏è‚É£ insert ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
    if (items.length > 0) {
      const { error: itemError } = await client.from('draft_items').insert(items);
      if(itemError) throw itemError;
    }

    // 5Ô∏è‚É£ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏ï‡πä‡∏∞
    if (table_id) {
      await client.from('tables').update({ status: '‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á' }).eq('id', table_id);
    }

    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');

  } catch(err) {
    console.log('saveDraft error:', err);
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î');
  }
}

function showBillModal() {
  const html = buildPrintView(); // ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
  document.getElementById('billContent').innerHTML = html;
  document.getElementById('billModal').style.display = 'flex';
}

function closeBillModal() {
  document.getElementById('billModal').style.display = 'none';
}

function printBill() {
  const printContents = document.getElementById('billContent').innerHTML;
  const w = window.open('', '', 'height=600,width=400');
  w.document.write('<html><head><title>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•</title></head><body>');
  w.document.write(printContents);
  w.document.write('</body></html>');
  w.document.close();
  w.print();
}

async function saveBill(){
  const billno = el('billno').value;
  const customer = el('customer').value;
  const total = safeEval(el('grand').textContent.replace(/[^\d.]/g,''));
  const cash = safeEval(el('cash').value);
  const change = safeEval(el('change').value);
  const note = el('note').value;

  // 1Ô∏è‚É£ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏´‡∏•‡∏±‡∏Å
  const { data: bill, error: billError } = await client.from('bills').insert([{
    billno, customer, table_id, total, cash, change, note, status:'closed'
  }]).select().single();

  if(billError){ alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏¥‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); console.log(billError); return; }

  // 2Ô∏è‚É£ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ bill_items
  const items = [];
  document.querySelectorAll('#menuItems input').forEach(inp=>{
    const qty = safeEval(inp.value);
    if(qty<=0) return;
    const menu_id = parseInt(inp.dataset.id);
    const menuItem = menuData.find(m=>m.id===menu_id);
    if(menuItem) items.push({ bill_id: bill.id, menu_id, qty, price: menuItem.price });
  });

  if(items.length>0){
    const { error: itemError } = await client.from('bill_items').insert(items);
    if(itemError) console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ bill_items ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', itemError);
  }

  // 3Ô∏è‚É£ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏á
  if(table_id){
    const { error:updateError } = await client.from('tables').update({ status:'‡∏ß‡πà‡∏≤‡∏á' }).eq('id', table_id);
    if(updateError) console.log('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏ï‡πä‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', updateError);
  }

  // 4Ô∏è‚É£ ‡∏•‡∏ö draft + draft_items
  const { data: draftData, error: draftError } = await client.from('drafts')
    .select('id').eq('billno', billno).single();

  if(draftData){
    await client.from('draft_items').delete().eq('draft_id', draftData.id);
    await client.from('drafts').delete().eq('id', draftData.id);
  }

  // 5Ô∏è‚É£ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•
  const w = window.open('', 'PRINT', 'height=600,width=800');
  w.document.write('<html><head><title>‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏¥‡∏•</title></head><body>');
  w.document.write(buildPrintView());
  w.document.write('</body></html>');
  w.document.close();
  w.focus();
  w.print();
  w.close();

  // 6Ô∏è‚É£ ‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏¥‡∏•
  el('billno').value = nextBillNo();
  document.querySelectorAll('#menuItems input').forEach(i=>i.value=''); 
  el('cash').value=''; 
  el('note').value=''; 
  calc();
}


window.addEventListener('DOMContentLoaded',()=>{
  el('today').textContent = todayText();
  el('billno').value = nextBillNo();
  loadTableName();
  loadMenu().then(loadDraft);

  el('btnHome').addEventListener('click', async () => {
  if (table_id) {
    // 1Ô∏è‚É£ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ draft ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const { data: draftData, error: draftError } = await client.from('drafts')
      .select('id')
      .eq('table_id', table_id)
      .single();

    // 2Ô∏è‚É£ ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ draft ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const hasUnsavedData = Array.from(document.querySelectorAll('#menuItems input')).some(inp => safeEval(inp.value) > 0) || el('customer').value.trim() !== '';

    if (!draftData && hasUnsavedData) {
      // 3Ô∏è‚É£ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏ß‡πà‡∏≤‡∏á' ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      const { error: updateError } = await client.from('tables').update({ status: '‡∏ß‡πà‡∏≤‡∏á' }).eq('id', table_id);
      if (updateError) {
        console.log('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏ï‡πä‡∏∞‡∏ß‡πà‡∏≤‡∏á‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', updateError);
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
      } else {
        alert('‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô "‡∏ß‡πà‡∏≤‡∏á"');
      }
    }
    // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ (‡∏°‡∏µ draft ‡∏´‡∏£‡∏∑‡∏≠‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ß‡πà‡∏≤‡∏á) ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞
  }

  // ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏™‡∏°‡∏≠
  window.location.href = 'index.html';
});
  el('btnAddMenu').addEventListener('click',()=>{el('popup').style.display='flex';});
  el('btnAddMenuCancel').addEventListener('click',()=>{el('popup').style.display='none'; el('newMenuName').value=''; el('newMenuPrice').value='';});
  el('btnAddMenuConfirm').addEventListener('click',async()=>{
    const name = el('newMenuName').value.trim();
    const price = parseFloat(el('newMenuPrice').value);
    if(!name || !price){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤'); return;}
    const { error } = await client.from('menu').insert([{ name, price }]);
    if(error){alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'); console.log(error);} 
    else { el('popup').style.display='none'; el('newMenuName').value=''; el('newMenuPrice').value=''; loadMenu(); }
  });

  el('btnPrint').addEventListener('click', showBillModal);
  el('btnSave').addEventListener('click',saveDraft);

  el('btnClear').addEventListener('click', async () => {
  if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏ß‡πà‡∏≤‡∏á'
    if (table_id) {
      const { error: updateError } = await client.from('tables').update({ status: '‡∏ß‡πà‡∏≤‡∏á' }).eq('id', table_id);
      if (updateError) {
        console.log('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', updateError);
      }
    }

    // ‡∏•‡∏ö draft ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ
    if (table_id) {
        const { data: draftData, error: draftError } = await client.from('drafts')
            .select('id').eq('table_id', table_id).single();
        if (draftData) {
            await client.from('draft_items').delete().eq('draft_id', draftData.id);
            await client.from('drafts').delete().eq('id', draftData.id);
        }
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°
    document.querySelectorAll('#menuItems input').forEach(i => i.value = '');
    el('customer').value = '';
    el('cash').value = '';
    el('note').value = '';
    calc();
    alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ö‡∏¥‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
  }
});

  el('cash').addEventListener('input',calc);
});
</script>
</body>
</html>
