<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ร้านเรือนชมพูเนื้อย่างเกาหลี - หน้าหลัก</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  body { font-family: system-ui, "Noto Sans Thai", sans-serif; margin: 0; background-color: #e6fff7; }
    header {
      background: linear-gradient(90deg, #ec4899, #d946ef);
      color: white;
      padding: clamp(12px, 2vw, 16px);
      text-align: center;
      font-size: clamp(16px, 2.5vw, 20px);
      font-weight: bold;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      position: relative;
    }
    
    header img {
      height: 100px;
      vertical-align: middle;
      margin-right: 8px;
    }
    
    header span {
      vertical-align: middle;
    }

    /* ===== Set IP button: มุมขวาล่างของ header ===== */
    #setIpBtn {
      position: absolute; /* หรือ fixed ถ้าต้องการให้เลื่อนตามหน้า */
      right: clamp(10px, 2vw, 16px);
      top: calc(0 + clamp(0px, 2vw, 16px) + 100px); /* 100px = ความสูง header */
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      z-index: 300;
    }
    #setIpBtn i { font-size: 14px; }
    #setIpBtn small {
      display:block;
      font-weight:400;
      font-size:11px;
      opacity:0.95;
    }
    #setIpBtn:hover { transform: translateY(-2px); }

    @media (max-width: 600px) {
      #setIpBtn {
        padding: 6px 10px;
        font-size:12px;
        top: calc(0 + 72px + 8px); /* ปรับตาม header บนมือถือ */
      }
    }
    /* ================================================ */
    
    /* ปุ่ม Floating Action Button แบบ Dynamic - ขนาดเล็กลง + สีสอดคล้องกราฟ */
    #reportButton {
      position: fixed;
      bottom: 6px;
      right: 6px;
      background: linear-gradient(135deg, #FBCFE8, #EC4899, #BE185D);
      color: #fff;
      border: none;
      padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 18px);
      border-radius: 50px;
      cursor: pointer;
      font-size: clamp(12px, 1.8vw, 14px);
      font-weight: 600;
      box-shadow: 0 6px 20px rgba(190,24,93,0.35); /* เงาโทนเข้ม */
      display: flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 100;
    }
    
    /* Hover effect */
    #reportButton:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
    }
    
    /* Icon */
    #reportButton i {
      font-size: clamp(14px, 1.8vw, 18px);
    }
    
    /* Mobile Adjust */
    @media (max-width: 600px) {
      #reportButton {
        bottom: 12px;
        right: 12px;
        padding: 10px 16px;
        font-size: 14px;
      }
      #reportButton i {
        font-size: 16px;
      }
    }

    .layout {
      display: grid; grid-template-columns: 90px 90px 90px 90px;
      grid-template-rows: repeat(12, 60px); gap: 12px; padding: 24px;
      justify-content: center;
    }
    .table-card {
      display: flex; align-items: center; justify-content: center;
      border-radius: 10px; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      padding: 6px; text-align: center;
    }
    .table-card:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .free { background: linear-gradient(135deg, #34d399, #10b981); color: white; }
    .busy { background: linear-gradient(135deg, #f87171, #ef4444); color: white; }
    .status-icon { font-size: 18px; margin-right: 6px; }
    .status-icon.free { color: #bbf7d0; }
    .status-icon.busy { color: #fecaca; }

    /* layout position */
    #table-ซุ้ม1 { grid-column: 1; grid-row: 10; }
    #table-ซุ้ม2 { grid-column: 1; grid-row: 9; }
    #table-ซุ้ม3 { grid-column: 1; grid-row: 8; }
    #table-ซุ้ม4 { grid-column: 1; grid-row: 7; }
    #table-ซุ้ม5 { grid-column: 1; grid-row: 6; }
    #table-ซุ้ม6 { grid-column: 1; grid-row: 5; }
    #table-ซุ้ม7 { grid-column: 1; grid-row: 4; }
    #table-ซุ้ม8 { grid-column: 1; grid-row: 3; }
    #table-ซุ้ม9 { grid-column: 1; grid-row: 2; }
    #table-ซุ้ม10 { grid-column: 1; grid-row: 1; }

    #table-A1 { grid-column: 2; grid-row: 8 / span 2; height:160px; width:80px; align-self:start; }
    #table-A2 { grid-column: 3; grid-row: 8 / span 2; height:160px; width:80px; align-self:start; }
    #table-A3 { grid-column:2 / span 2; grid-row:7; height:50px; }
    #table-A4 { grid-column:2 / span 2; grid-row:6; height:50px; }
    #table-A5 { grid-column:2 / span 2; grid-row:5; height:50px; }
    #table-A6 { grid-column:2 / span 2; grid-row:4; height:50px; }
    #table-A7 { grid-column:2 / span 2; grid-row:3; height:50px; }
    #table-A8 { grid-column:2 / span 2; grid-row:2; height:50px; }

    #table-B1 { grid-column: 4; grid-row: 8; }
    #table-B2 { grid-column: 4; grid-row: 7; }
    #table-B3 { grid-column: 4; grid-row: 6; }
    #table-B4 { grid-column: 4; grid-row: 5; }
  
    .layout {
      position: relative;
      z-index: 1; /* โต๊ะอยู่ข้างหน้า */
    }
</style>
</head>
<body>
<header>
  <img src="images/LOGO.png" alt="โลโก้ร้าน">
  <span>ร้านเรือนชมพูเนื้อย่างเกาหลี • สาขานาเชือก</span>
</header>

<button id="setIpBtn" onclick="openIpModal()" aria-label="ตั้งค่า IP เครื่องพิมพ์">
  <i class="fa-solid fa-network-wired"></i>
  <div style="text-align:left; line-height:1;">
    <div style="font-weight:700; font-size:13px;">Set IP</div>
    <small id="ipLabel">192.168.1.100</small>
  </div>
</button>

<button id="reportButton" onclick="openReport()">
  <i class="fa-solid fa-chart-line"></i> ดูรายงาน
</button>

<!-- Modal IP -->
<div id="ipModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
     background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
  <div style="background:white; padding:24px; border-radius:16px; width:90%; max-width:400px; box-shadow:0 6px 16px rgba(0,0,0,0.25);">
    <h3 style="margin-top:0;">ตั้งค่า IP เครื่องพิมพ์</h3>
    <input type="text" id="printerIpInput" placeholder="192.168.1.100" style="width:100%; padding:8px; margin-bottom:16px; border-radius:8px; border:1px solid #ccc;">
    <div style="display:flex; justify-content:flex-end; gap:8px;">
      <button onclick="closeIpModal()" style="background:#ccc; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">ยกเลิก</button>
      <button onclick="saveIp()" style="background:#f59e0b; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">บันทึก</button>
    </div>
  </div>
</div>

<div class="layout" id="tables">
  <!-- fix โต๊ะ -->
  <div id="table-ซุ้ม1" class="table-card"></div>
  <div id="table-ซุ้ม2" class="table-card"></div>
  <div id="table-ซุ้ม3" class="table-card"></div>
  <div id="table-ซุ้ม4" class="table-card"></div>
  <div id="table-ซุ้ม5" class="table-card"></div>
  <div id="table-ซุ้ม6" class="table-card"></div>
  <div id="table-ซุ้ม7" class="table-card"></div>
  <div id="table-ซุ้ม8" class="table-card"></div>
  <div id="table-ซุ้ม9" class="table-card"></div>
  <div id="table-ซุ้ม10" class="table-card"></div>
  <div id="table-A1" class="table-card"></div>
  <div id="table-A2" class="table-card"></div>
  <div id="table-A3" class="table-card"></div>
  <div id="table-A4" class="table-card"></div>
  <div id="table-A5" class="table-card"></div>
  <div id="table-A6" class="table-card"></div>
  <div id="table-A7" class="table-card"></div>
  <div id="table-A8" class="table-card"></div>
  <div id="table-B1" class="table-card"></div>
  <div id="table-B2" class="table-card"></div>
  <div id="table-B3" class="table-card"></div>
  <div id="table-B4" class="table-card"></div>
</div>

<div id="reportModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:white; padding:24px; border-radius:16px; width:95%; max-width:900px; max-height:90%; overflow:auto; box-shadow:0 6px 16px rgba(0,0,0,0.25);">
    <!-- ... Report Modal Content (เหมือนเดิม) ... -->
  </div>
</div>


<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const tables = [
  { id: 1, name: "ซุ้ม1" }, { id: 2, name: "ซุ้ม2" }, { id: 3, name: "ซุ้ม3" }, { id: 4, name: "ซุ้ม4" },
  { id: 5, name: "ซุ้ม5" }, { id: 6, name: "ซุ้ม6" }, { id: 7, name: "ซุ้ม7" }, { id: 8, name: "ซุ้ม8" },
  { id: 9, name: "ซุ้ม9" }, { id: 10, name: "ซุ้ม10" }, { id: 11, name: "A1" }, { id: 12, name: "A2" },
  { id: 13, name: "A3" }, { id: 14, name: "A4" }, { id: 15, name: "A5" }, { id: 16, name: "A6" },
  { id: 17, name: "A7" }, { id: 18, name: "A8" }, { id: 19, name: "B1" }, { id: 20, name: "B2" },
  { id: 21, name: "B3" }, { id: 22, name: "B4" }
];

// ------------------ Hybrid Cache ------------------
function saveToCache(key, value) {
  localStorage.setItem(key, JSON.stringify({ value, timestamp: Date.now() }));
}

function loadFromCache(key, maxAge = 60000) { // default 1 นาที
  const raw = localStorage.getItem(key);
  if (!raw) return null;
  try {
    const obj = JSON.parse(raw);
    if (Date.now() - obj.timestamp > maxAge) return null;
    return obj.value;
  } catch(e){ return null; }
}
// --------------------------------------------------

async function ensureTablesExist() {
  const cached = loadFromCache('tablesCache', 10*60*1000);
  if (cached) return cached;

  const { data: dbTables, error } = await client.from('tables').select('id');
  if (error) { console.error(error); return; }
  const existingIds = dbTables.map(t => t.id);
  const missing = tables.filter(t => !existingIds.includes(t.id));

  if (missing.length > 0) {
    const { data, error: upsertError } = await client.from('tables').upsert(
      missing.map(m => ({ id: m.id, name: m.name, status: "ว่าง" }))
    );
    if (upsertError) console.error("Upsert error:", upsertError);
  }

  const { data: allTables } = await client.from('tables').select('*');
  saveToCache('tablesCache', allTables);
  return allTables;
}

async function loadTables() {
  let data = loadFromCache('tablesCache', 30*1000); // 30 วิ
  if (!data) data = await ensureTablesExist();

  tables.forEach(t => {
    const div = document.getElementById("table-" + t.name);
    if (!div) return;

    const record = data.find(d => d.id === t.id);
    const status = record ? record.status : "ว่าง";

    div.className = 'table-card ' + (status === 'ว่าง' ? 'free' : 'busy');
    div.innerHTML = '';
    const icon = document.createElement('i');
    icon.className = status === 'ว่าง'
      ? 'fa-solid fa-circle-check status-icon free'
      : 'fa-solid fa-circle-xmark status-icon busy';
    const label = document.createElement('span');
    label.textContent = `${t.name} (${status})`;

    div.appendChild(icon);
    div.appendChild(label);

    div.onclick = async () => {
      if (status === 'ว่าง') {
        const { error } = await client.from('tables').update({ status: 'ไม่ว่าง' }).eq('id', t.id);
        if (error) { console.error(error); alert('อัปเดตสถานะโต๊ะผิดพลาด'); return; }
      }
      window.location.href = `bill.html?table_id=${t.id}`;
    };
  });
}

// ------------------ Sales Summary ------------------
async function loadSalesSummary() {
  let summary = loadFromCache('salesSummary', 60*1000);
  if (!summary) {
    const [{ data: daily }, { data: monthly }, { data: yearly }] = await Promise.all([
      client.rpc('get_daily_sales'),
      client.rpc('get_monthly_sales'),
      client.rpc('get_yearly_sales')
    ]);
    summary = {
      daily: daily?.[0]?.total_sales || 0,
      monthly: monthly?.[0]?.total_sales || 0,
      yearly: yearly?.[0]?.total_sales || 0
    };
    saveToCache('salesSummary', summary);
  }

  document.getElementById('dailySales').textContent = summary.daily.toLocaleString("th-TH");
  document.getElementById('monthlySales').textContent = summary.monthly.toLocaleString("th-TH");
  document.getElementById('yearlySales').textContent = summary.yearly.toLocaleString("th-TH");
}

// ------------------ Chart & History ------------------
let salesChart;
async function loadSalesChart(mode='daily') {
  let cacheKey = 'salesChart_'+mode;
  let chartData = loadFromCache(cacheKey, 60*1000);
  if (!chartData) {
    let fromDate = new Date();
    if (mode==='daily') fromDate.setDate(fromDate.getDate()-30);
    else if (mode==='monthly') fromDate = new Date(new Date().getFullYear(),0,1);
    else fromDate = new Date(new Date().getFullYear()-4,0,1);

    const { data, error } = await client.from('bills')
      .select('closed_at,total').eq('status','closed')
      .gte('closed_at', fromDate.toISOString())
      .order('closed_at',{ascending:true});
    if (error) { console.error(error); return; }

    const grouped = {};
    data.forEach(b => {
      const d = new Date(b.closed_at);
      let key = mode==='daily'? d.toLocaleDateString('th-TH')
              : mode==='monthly'? d.toLocaleString('th-TH',{year:'numeric',month:'short'})
              : d.getFullYear();
      grouped[key] = (grouped[key]||0) + Number(b.total);
    });
    chartData = { labels: Object.keys(grouped), totals: Object.values(grouped) };
    saveToCache(cacheKey, chartData);
  }

  const ctx = document.getElementById('salesChart').getContext('2d');
  if (salesChart) salesChart.destroy();
  salesChart = new Chart(ctx, {
    type:'bar',
    data:{ labels: chartData.labels, datasets:[{label:'ยอดขาย (บาท)', data: chartData.totals, backgroundColor: mode==='daily'?'#24d67a':mode==='monthly'?'#19d3d3':'#3b82f6'}] },
    options:{ responsive:true, plugins:{legend:{display:false}, tooltip:{callbacks:{label:c=>c.raw.toLocaleString('th-TH')+' บาท'}}}, scales:{y:{beginAtZero:true,ticks:{callback:v=>v.toLocaleString('th-TH')}}} }
  });
}

// ------------------ Realtime Update ------------------
client.channel('tables-changes')
  .on('postgres_changes',{ event:'*', schema:'public', table:'tables'}, payload=>{
    console.log('Realtime table change', payload);
    localStorage.removeItem('tablesCache'); // ล้าง cache
    loadTables();
  })
  .subscribe();

// ------------------ Init ------------------
window.addEventListener('DOMContentLoaded', ()=>{
  updateIpLabel();
  (async ()=>{
    await ensureTablesExist();
    await loadTables();
  })();
});
</script>
</body>
</html>
