<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>à¹€à¸£à¸·à¸­à¸™à¸Šà¸¡à¸à¸¹à¹€à¸™à¸·à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸à¸²à¸«à¸¥à¸µ - à¸ªà¸²à¸‚à¸²à¸™à¸²à¹€à¸Šà¸·à¸­à¸</title>
  <link rel="icon" type="image/png" href="https://SoPorsri.github.io/ruenchompoo/images/LOGO.png">
  <link rel="shortcut icon" href="https://SoPorsri.github.io/ruenchompoo/images/LOGO.png">
  <!-- à¹‚à¸«à¸¥à¸” Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  
  <style>
    body { font-family: system-ui, "Noto Sans Thai", sans-serif; margin: 0; background-color: #e6fff7; }
    header {
      background: linear-gradient(90deg, #ec4899, #d946ef);
      color: white;
      padding: clamp(12px, 2vw, 16px);
      text-align: center;
      font-size: clamp(16px, 2.5vw, 20px);
      font-weight: bold;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      position: relative;
    }
    
    header img {
      height: 100px;
      vertical-align: middle;
      margin-right: 8px;
    }
    
    header span {
      vertical-align: middle;
    }

    /* ===== Set IP button: à¸¡à¸¸à¸¡à¸‚à¸§à¸²à¸¥à¹ˆà¸²à¸‡à¸‚à¸­à¸‡ header ===== */
    #setIpBtn {
      position: absolute; /* à¸«à¸£à¸·à¸­ fixed à¸–à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰à¹€à¸¥à¸·à¹ˆà¸­à¸™à¸•à¸²à¸¡à¸«à¸™à¹‰à¸² */
      right: clamp(10px, 2vw, 16px);
      top: calc(0 + clamp(0px, 2vw, 16px) + 100px); /* 100px = à¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡ header */
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      z-index: 300;
    }
    #setIpBtn i { font-size: 14px; }
    #setIpBtn small {
      display:block;
      font-weight:400;
      font-size:11px;
      opacity:0.95;
    }
    #setIpBtn:hover { transform: translateY(-2px); }

    @media (max-width: 600px) {
      #setIpBtn {
        padding: 6px 10px;
        font-size:12px;
        top: calc(0 + 72px + 8px); /* à¸›à¸£à¸±à¸šà¸•à¸²à¸¡ header à¸šà¸™à¸¡à¸·à¸­à¸–à¸·à¸­ */
      }
    }
    /* ================================================ */
    
    /* à¸›à¸¸à¹ˆà¸¡ Floating Action Button à¹à¸šà¸š Dynamic - à¸‚à¸™à¸²à¸”à¹€à¸¥à¹‡à¸à¸¥à¸‡ + à¸ªà¸µà¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡à¸à¸£à¸²à¸Ÿ */
    #reportButton {
      position: fixed;
      bottom: 6px;
      right: 6px;
      background: linear-gradient(135deg, #FBCFE8, #EC4899, #BE185D);
      color: #fff;
      border: none;
      padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 18px);
      border-radius: 50px;
      cursor: pointer;
      font-size: clamp(12px, 1.8vw, 14px);
      font-weight: 600;
      box-shadow: 0 6px 20px rgba(190,24,93,0.35); /* à¹€à¸‡à¸²à¹‚à¸—à¸™à¹€à¸‚à¹‰à¸¡ */
      display: flex;
      align-items: center;
      gap: 4px;
      transition: transform 0.2s, box-shadow 0.2s;
      z-index: 100;
    }
    
    /* Hover effect */
    #reportButton:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
    }
    
    /* Icon */
    #reportButton i {
      font-size: clamp(14px, 1.8vw, 18px);
    }
    
    /* Mobile Adjust */
    @media (max-width: 600px) {
      #reportButton {
        bottom: 12px;
        right: 12px;
        padding: 10px 16px;
        font-size: 14px;
      }
      #reportButton i {
        font-size: 16px;
      }
    }

    .layout {
      display: grid; grid-template-columns: 90px 90px 90px 90px;
      grid-template-rows: repeat(12, 60px); gap: 12px; padding: 24px;
      justify-content: center;
    }
    .table-card {
      display: flex; align-items: center; justify-content: center;
      border-radius: 10px; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      padding: 6px; text-align: center;
    }
    .table-card:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
    .free { background: linear-gradient(135deg, #34d399, #10b981); color: white; }
    .busy { background: linear-gradient(135deg, #f87171, #ef4444); color: white; }
    .status-icon { font-size: 18px; margin-right: 6px; }
    .status-icon.free { color: #bbf7d0; }
    .status-icon.busy { color: #fecaca; }

    /* layout position */
    #table-à¸‹à¸¸à¹‰à¸¡1 { grid-column: 1; grid-row: 10; }
    #table-à¸‹à¸¸à¹‰à¸¡2 { grid-column: 1; grid-row: 9; }
    #table-à¸‹à¸¸à¹‰à¸¡3 { grid-column: 1; grid-row: 8; }
    #table-à¸‹à¸¸à¹‰à¸¡4 { grid-column: 1; grid-row: 7; }
    #table-à¸‹à¸¸à¹‰à¸¡5 { grid-column: 1; grid-row: 6; }
    #table-à¸‹à¸¸à¹‰à¸¡6 { grid-column: 1; grid-row: 5; }
    #table-à¸‹à¸¸à¹‰à¸¡7 { grid-column: 1; grid-row: 4; }
    #table-à¸‹à¸¸à¹‰à¸¡8 { grid-column: 1; grid-row: 3; }
    #table-à¸‹à¸¸à¹‰à¸¡9 { grid-column: 1; grid-row: 2; }
    #table-à¸‹à¸¸à¹‰à¸¡10 { grid-column: 1; grid-row: 1; }

    #table-A1 { grid-column: 2; grid-row: 8 / span 2; height:160px; width:80px; align-self:start; }
    #table-A2 { grid-column: 3; grid-row: 8 / span 2; height:160px; width:80px; align-self:start; }
    #table-A3 { grid-column:2 / span 2; grid-row:7; height:50px; }
    #table-A4 { grid-column:2 / span 2; grid-row:6; height:50px; }
    #table-A5 { grid-column:2 / span 2; grid-row:5; height:50px; }
    #table-A6 { grid-column:2 / span 2; grid-row:4; height:50px; }
    #table-A7 { grid-column:2 / span 2; grid-row:3; height:50px; }
    #table-A8 { grid-column:2 / span 2; grid-row:2; height:50px; }

    #table-B1 { grid-column: 4; grid-row: 8; }
    #table-B2 { grid-column: 4; grid-row: 7; }
    #table-B3 { grid-column: 4; grid-row: 6; }
    #table-B4 { grid-column: 4; grid-row: 5; }
  
    .layout {
      position: relative;
      z-index: 1; /* à¹‚à¸•à¹Šà¸°à¸­à¸¢à¸¹à¹ˆà¸‚à¹‰à¸²à¸‡à¸«à¸™à¹‰à¸² */
    }

    .filter-box {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 14px;
      align-items: flex-end;
      background: #f8fafc;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    .filter-box .field {
      display: flex;
      flex-direction: column;
    }
    .filter-box label {
      font-size: 13px;
      color: #374151;
      margin-bottom: 4px;
      font-weight: 500;
    }
    .filter-box input[type="date"],
    .filter-box input[type="text"] {
      padding: 8px 10px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .filter-box input:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 0 2px rgba(59,130,246,0.2);
    }
    .btn-clear {
      background-color: #fca5a5; /* à¸ªà¸µà¹à¸”à¸‡à¸ˆà¸²à¸‡ */
      color: #ffffff;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
    }
    
    .btn-clear:hover {
      background-color: #f87171; /* à¸ªà¸µà¹à¸”à¸‡à¹€à¸‚à¹‰à¸¡à¸‚à¸¶à¹‰à¸™à¹€à¸¡à¸·à¹ˆà¸­ hover */
      transform: scale(1.05);
    }
    
    .btn-clear:active {
      transform: scale(0.95);
    }

    .floating-btn {
      position: fixed;
      bottom: 20px;
      padding: 10px 20px;
      font-family: Tahoma, sans-serif;
      font-size: 14px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      z-index: 999;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: all 0.2s ease-in-out;
      display: flex;
      align-items: center;
      gap: 8px; /* à¸£à¸°à¸¢à¸°à¸«à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ icon à¸à¸±à¸šà¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ */
    }
    .floating-btn.left {
      left: 20px;
      background-color: #ffb347;
      color: #000;
    }
    .floating-btn.left:hover {
      background-color: #ffa31a;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.25);
    }
  </style>
</head>
<body>
  <header>
    <img src="images/LOGO.png" alt="à¹‚à¸¥à¹‚à¸à¹‰à¸£à¹‰à¸²à¸™">
    <span>à¸£à¹‰à¸²à¸™à¹€à¸£à¸·à¸­à¸™à¸Šà¸¡à¸à¸¹à¹€à¸™à¸·à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸à¸²à¸«à¸¥à¸µ â€¢ à¸ªà¸²à¸‚à¸²à¸™à¸²à¹€à¸Šà¸·à¸­à¸</span>
  </header>

  <!-- à¸›à¸¸à¹ˆà¸¡ Set IP à¸™à¸­à¸ header à¹à¸•à¹ˆà¹ƒà¸«à¹‰à¸­à¸¢à¸¹à¹ˆà¸¡à¸¸à¸¡à¸‚à¸§à¸²à¸¥à¹ˆà¸²à¸‡à¸‚à¸­à¸‡ header -->
  <button id="setIpBtn" onclick="openIpModal()" aria-label="à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² IP à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œ">
    <i class="fa-solid fa-network-wired"></i>
    <div style="text-align:left; line-height:1;">
      <div style="font-weight:700; font-size:13px;">Set IP</div>
      <small id="ipLabel">192.168.1.100</small>
    </div>
  </button>

  <button id="btnTakeHome" class="floating-btn left">
    <i class="fa-solid fa-cart-shopping"></i> à¸‹à¸·à¹‰à¸­à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™
  </button>
  <!-- à¸›à¸¸à¹ˆà¸¡ Floating Action Button -->
  <button id="reportButton" onclick="openReport()">
    <i class="fa-solid fa-chart-line"></i> à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™
  </button>

  <!-- Modal -->
  <div id="ipModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
       background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
    <div style="background:white; padding:24px; border-radius:16px; width:90%; max-width:400px; box-shadow:0 6px 16px rgba(0,0,0,0.25);">
      <h3 style="margin-top:0;">à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² IP à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œ</h3>
      <input type="text" id="printerIpInput" placeholder="192.168.1.100" 
             style="width:100%; padding:8px; margin-bottom:16px; border-radius:8px; border:1px solid #ccc;">
      <div style="display:flex; justify-content:flex-end; gap:8px;">
        <button onclick="closeIpModal()" style="background:#ccc; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">à¸¢à¸à¹€à¸¥à¸´à¸</button>
        <button onclick="saveIp()" style="background:#f59e0b; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">à¸šà¸±à¸™à¸—à¸¶à¸</button>
      </div>
    </div>
  </div>
  
  <div class="layout" id="tables">
    <!-- fix à¹‚à¸•à¹Šà¸° -->
    <div id="table-à¸‹à¸¸à¹‰à¸¡1" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡2" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡3" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡4" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡5" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡6" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡7" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡8" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡9" class="table-card"></div>
    <div id="table-à¸‹à¸¸à¹‰à¸¡10" class="table-card"></div>
    <div id="table-A1" class="table-card"></div>
    <div id="table-A2" class="table-card"></div>
    <div id="table-A3" class="table-card"></div>
    <div id="table-A4" class="table-card"></div>
    <div id="table-A5" class="table-card"></div>
    <div id="table-A6" class="table-card"></div>
    <div id="table-A7" class="table-card"></div>
    <div id="table-A8" class="table-card"></div>
    <div id="table-B1" class="table-card"></div>
    <div id="table-B2" class="table-card"></div>
    <div id="table-B3" class="table-card"></div>
    <div id="table-B4" class="table-card"></div>
  </div>

  <div id="reportModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
  background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
    <div style="background:white; padding:24px; border-radius:16px; width:95%; max-width:900px; max-height:90%; overflow:auto;
                box-shadow:0 6px 16px rgba(0,0,0,0.25);">
      
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h2 style="margin:0; color:#d946ef">ğŸ“Š à¸£à¸²à¸¢à¸‡à¸²à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢</h2>
        <button onclick="closeReport()" style="border:none; background:none; font-size:22px; cursor:pointer; color:#666;">âœ–</button>
      </div>
  
      <!-- Summary -->
      <div style="display:flex; gap:20px; margin-bottom:24px; flex-wrap:wrap;">
          <div style="flex:1; background:#e8fdf2; padding:16px; border-radius:12px; text-align:center;">
            <h3 style="margin:0; color:#24d67a;">à¸§à¸±à¸™à¸™à¸µà¹‰</h3>
            <p id="dailySales" style="font-size:20px; font-weight:bold; margin:4px 0;">0</p>
          </div>
          <div style="flex:1; background:#e8f8ff; padding:16px; border-radius:12px; text-align:center;">
            <h3 style="margin:0; color:#19d3d3;">à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰</h3>
            <p id="monthlySales" style="font-size:20px; font-weight:bold; margin:4px 0;">0</p>
          </div>
          <div style="flex:1; background:#dbeafe; padding:16px; border-radius:12px; text-align:center;">
            <h3 style="margin:0; color:#3b82f6;">à¸›à¸µà¸™à¸µà¹‰</h3>
            <p id="yearlySales" style="font-size:20px; font-weight:bold; margin:4px 0;">0</p>
          </div>
          <div style="flex:1; background:#fffbe6; padding:16px; border-radius:12px; text-align:center;">
            <h3 style="margin:0; color:#f59e0b;">à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™ (à¸§à¸±à¸™à¸™à¸µà¹‰)</h3>
            <p id="dailyTakehomeSales" style="font-size:20px; font-weight:bold; margin:4px 0;">0</p>
          </div>
      </div>
  
      <!-- Chart -->
      <h3 style="margin-top:0;"><i class="fas fa-chart-line"></i> à¸à¸£à¸²à¸Ÿà¸¢à¸­à¸”à¸‚à¸²à¸¢</h3>
      <div style="margin-bottom:12px;">
        <button onclick="loadSalesChart('daily')" 
          style="background:#24d67a; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">
          à¸£à¸²à¸¢à¸§à¸±à¸™
        </button>
        <button onclick="loadSalesChart('monthly')" 
          style="background:#19d3d3; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">
          à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™
        </button>
        <button onclick="loadSalesChart('yearly')" 
          style="background:#3b82f6; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">
          à¸£à¸²à¸¢à¸›à¸µ
        </button>
      </div>
      <canvas id="salesChart" height="120"></canvas>
  
      <!-- Toggle History -->
      <div style="margin-top:24px;">
        <button onclick="toggleHistory()" 
          style="background:#ec4899; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer;">
          <i class="fa-solid fa-clock-rotate-left"></i> à¸”à¸¹à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸‚à¸²à¸¢
        </button>
        <button onclick="exportToExcel()" 
          style="background:#10b981; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer;">
          <i class="fa-solid fa-file-excel"></i> Export Excel
        </button>
      </div>
  
      <!-- History Table -->
      <div id="historySection" style="display:none; margin-top:16px;">
        <h3><i class="fas fa-receipt"></i> à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸‚à¸²à¸¢à¸¥à¹ˆà¸²à¸ªà¸¸à¸”</h3>
        <div class="filter-box">
          <div class="field">
            <label><i class="fa-solid fa-calendar-day"></i> à¸ˆà¸²à¸à¸§à¸±à¸™à¸—à¸µà¹ˆ</label>
            <input type="date" id="fromDate">
          </div>
          <div class="field">
            <label><i class="fa-solid fa-calendar-check"></i> à¸–à¸¶à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ</label>
            <input type="date" id="toDate">
          </div>
          <div class="field">
            <label><i class="fa-solid fa-magnifying-glass"></i> à¸„à¹‰à¸™à¸«à¸²à¸‹à¸¸à¹‰à¸¡/à¹€à¸¥à¸‚à¸šà¸´à¸¥</label>
            <input type="text" id="searchText" placeholder="à¹ƒà¸ªà¹ˆà¸Šà¸·à¹ˆà¸­à¸‹à¸¸à¹‰à¸¡ à¸«à¸£à¸·à¸­ à¹€à¸¥à¸‚à¸šà¸´à¸¥...">
          </div>
          <button id="clearBtn" class="btn-clear"><i class="fa-solid fa-eraser"></i> à¸¥à¹‰à¸²à¸‡à¸„à¹ˆà¸²</button>
        </div>
      
        <table border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse; font-size:14px;">
          <thead>
            <tr style="background:#f9fafb;">
              <th>à¹€à¸¥à¸‚à¸šà¸´à¸¥</th>
              <th>à¸¥à¸¹à¸à¸„à¹‰à¸²/à¹‚à¸•à¹Šà¸°</th>
              <th>à¸¢à¸­à¸”à¸£à¸§à¸¡</th>
              <th>à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸”à¸šà¸´à¸¥</th>
              <th>à¹€à¸§à¸¥à¸²à¸›à¸´à¸”à¸šà¸´à¸¥</th>
              <th>à¸à¸´à¸¡à¸à¹Œ</th>
              <th>ESC/POS</th>
            </tr>
          </thead>
          <tbody id="salesHistory"></tbody>
        </table>
        <h3 style="margin-top:24px; color:#f59e0b;"><i class="fa-solid fa-bag-shopping"></i> à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸‹à¸·à¹‰à¸­à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™</h3>
Â  Â  Â  Â  <table border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse; font-size:14px;">
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr style="background:#fefce8;">
Â  Â  Â  Â  Â  Â  Â  <th>à¹€à¸§à¸¥à¸²</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¸¢à¸­à¸”à¸£à¸§à¸¡ (à¸¿)</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¸›à¸£à¸°à¹€à¸ à¸—à¸à¸´à¸¡à¸à¹Œ</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¸£à¸²à¸¢à¸à¸²à¸£ (JSON)</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="takehomeHistory"></tbody> Â  Â  Â  Â  
        </table>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    const tables = [
      { id: 1, name: "à¸‹à¸¸à¹‰à¸¡1" }, { id: 2, name: "à¸‹à¸¸à¹‰à¸¡2" }, { id: 3, name: "à¸‹à¸¸à¹‰à¸¡3" }, { id: 4, name: "à¸‹à¸¸à¹‰à¸¡4" },
      { id: 5, name: "à¸‹à¸¸à¹‰à¸¡5" }, { id: 6, name: "à¸‹à¸¸à¹‰à¸¡6" }, { id: 7, name: "à¸‹à¸¸à¹‰à¸¡7" }, { id: 8, name: "à¸‹à¸¸à¹‰à¸¡8" },
      { id: 9, name: "à¸‹à¸¸à¹‰à¸¡9" }, { id: 10, name: "à¸‹à¸¸à¹‰à¸¡10" }, { id: 11, name: "A1" }, { id: 12, name: "A2" },
      { id: 13, name: "A3" }, { id: 14, name: "A4" }, { id: 15, name: "A5" }, { id: 16, name: "A6" },
      { id: 17, name: "A7" }, { id: 18, name: "A8" }, { id: 19, name: "B1" }, { id: 20, name: "B2" },
      { id: 21, name: "B3" }, { id: 22, name: "B4" }
    ];

    async function ensureTablesExist() {
      const { data: dbTables, error } = await client.from('tables').select('id');
      if (error) { console.error(error); return; }
      const existingIds = dbTables.map(t => t.id);
      const missing = tables.filter(t => !existingIds.includes(t.id));

      if (missing.length > 0) {
        console.log("Insert missing tables:", missing);
        // destructure data, error à¸­à¸­à¸à¸¡à¸²
        const { data, error: upsertError } = await client.from('tables').upsert(
          missing.map(m => ({ id: m.id, name: m.name, status: "à¸§à¹ˆà¸²à¸‡" }))
        );
        if (upsertError) {
          console.error("Upsert error:", upsertError);
        } else {
          console.log("Upsert success:", data);
        }
      }
    }

    async function loadTables() {
      // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ render à¸•à¸²à¸£à¸²à¸‡
      function renderTables(statusMap) {
        tables.forEach(t => {
          const div = document.getElementById("table-" + t.name);
          if (!div) return;
          const status = statusMap[t.id] || "à¸§à¹ˆà¸²à¸‡";
    
          div.className = 'table-card ' + (status === 'à¸§à¹ˆà¸²à¸‡' ? 'free' : 'busy');
          div.innerHTML = `
            <i class="fa-solid ${status === 'à¸§à¹ˆà¸²à¸‡' ? 'fa-circle-check free' : 'fa-circle-xmark busy'} status-icon"></i>
            <span>${t.name} (${status})</span>
          `;
          div.onclick = async () => {
            if (status === 'à¸§à¹ˆà¸²à¸‡') {
              const { error: updateError } = await client.from('tables')
                .update({ status: 'à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸‡' })
                .eq('id', t.id);
              if (updateError) {
                console.error(updateError);
                alert('à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¹‚à¸•à¹Šà¸°à¸œà¸´à¸”à¸à¸¥à¸²à¸”');
                return;
              }
            }
            window.location.href = `bill.html?table_id=${t.id}`;
          };
        });
      }
    
      const cache = JSON.parse(localStorage.getItem('tablesStatus') || '{}');
      renderTables(cache);
    
      const { data, error } = await client.from('tables').select('id,status');
      if (error) {
        console.error(error);
        return;
      }

      const statusMap = {};
      data.forEach(d => { statusMap[d.id] = d.status; });
    
      // à¸­à¸±à¸›à¹€à¸”à¸• DOM à¹à¸¥à¸°à¹€à¸à¹‡à¸š cache
      renderTables(statusMap);
      localStorage.setItem('tablesStatus', JSON.stringify(statusMap));
    }
    let salesChart;

    function openReport() {
Â  Â  Â  // â¬‡ï¸ à¸•à¸±à¹‰à¸‡à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸•à¸£à¸‡à¸™à¸µà¹‰
Â  Â  Â  const CORRECT_PASSWORD = "abc123"; // â€¼ï¸*** à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸•à¹‰à¸­à¸‡à¸à¸²à¸£ ***â€¼ï¸
Â  Â  Â  const password = prompt("à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆà¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹€à¸à¸·à¹ˆà¸­à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™:");
Â  Â  Â  if (password === CORRECT_PASSWORD) {
Â  Â  Â  Â  document.getElementById('reportModal').style.display = 'flex';
Â  Â  Â  Â  loadSalesSummary();
Â  Â  Â  Â  loadSalesChart('daily');
Â  Â  Â  } else if (password !== null) {
Â  Â  Â  Â  alert("à¸£à¸«à¸±à¸ªà¸œà¹ˆà¸²à¸™à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡!");
Â  Â  Â  }
Â  Â  }
    function closeReport() {
      document.getElementById('reportModal').style.display = 'none';
    }

    // ğŸ”¹ à¸›à¸¸à¹ˆà¸¡ Clear à¸£à¸µà¹€à¸‹à¹‡à¸•à¸„à¹ˆà¸²à¹à¸¥à¸°à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
    document.getElementById('clearBtn').addEventListener('click', () => {
      document.getElementById('fromDate').value = '';
      document.getElementById('toDate').value = '';
      document.getElementById('searchText').value = '';
      loadSalesHistory(); // à¹‚à¸«à¸¥à¸”à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ (à¸§à¸±à¸™à¸™à¸µà¹‰)
    });
      
    function toggleHistory() {
      const section = document.getElementById('historySection');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        loadSalesHistory();
      } else {
        section.style.display = 'none';
      }
    }

    function reprintBill(billId) {
      // à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸à¸´à¸¡à¸à¹Œà¸šà¸´à¸¥à¹ƒà¸«à¸¡à¹ˆ à¸à¸£à¹‰à¸­à¸¡à¸ªà¹ˆà¸‡ bill_id
      window.open(`printbill.html?bill_id=${billId}`, '_blank');
    }

    // --- à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸à¸´à¸¡à¸à¹Œ ESC/POS ---
    function openPOS(billId) {
      window.open(`printPOS.html?bill_id=${billId}`, '_blank');
    }
      
    async function loadSalesSummary() {
      const { data: daily } = await client.rpc('get_daily_sales');
      const { data: monthly } = await client.rpc('get_monthly_sales');
      const { data: yearly } = await client.rpc('get_yearly_sales');
    
      document.getElementById('dailySales').textContent = 
        (daily?.[0]?.total_sales || 0).toLocaleString("th-TH");
      document.getElementById('monthlySales').textContent = 
        (monthly?.[0]?.total_sales || 0).toLocaleString("th-TH");
      document.getElementById('yearlySales').textContent = 
        (yearly?.[0]?.total_sales || 0).toLocaleString("th-TH");

Â  Â  Â  const today = new Date();
Â  Â  Â  today.setHours(0, 0, 0, 0);
Â  Â  Â  const tomorrow = new Date(today);
Â  Â  Â  tomorrow.setDate(tomorrow.getDate() + 1);
Â  Â  Â  const { data: takehome, error } = await client
Â  Â  Â  Â  .from('takehome_sales')
Â  Â  Â  Â  .select('total_amount')
Â  Â  Â  Â  .gte('created_at', today.toISOString()) // à¸¡à¸²à¸à¸à¸§à¹ˆà¸²à¸«à¸£à¸·à¸­à¹€à¸—à¹ˆà¸²à¸à¸±à¸š à¹€à¸—à¸µà¹ˆà¸¢à¸‡à¸„à¸·à¸™à¸§à¸±à¸™à¸™à¸µà¹‰
Â  Â  Â  Â  .lt('created_at', tomorrow.toISOString()); // à¸™à¹‰à¸­à¸¢à¸à¸§à¹ˆà¸² à¹€à¸—à¸µà¹ˆà¸¢à¸‡à¸„à¸·à¸™à¸à¸£à¸¸à¹ˆà¸‡à¸™à¸µà¹‰
Â  Â  Â Â 
Â  Â  Â  if (error) {
Â  Â  Â  Â  console.error("Error fetching takehome sales:", error);
Â  Â  Â  }
Â  Â  Â  const totalTakehome = takehome ? takehome.reduce((sum, sale) => sum + sale.total_amount, 0) : 0;
Â  Â  Â  document.getElementById('dailyTakehomeSales').textContent = totalTakehome.toLocaleString("th-TH");
    }
  
    async function loadSalesChart(mode = 'daily') {
      let fromDate;
      if (mode === 'daily') {
        fromDate = new Date(Date.now() - 30*24*60*60*1000); // 30 à¸§à¸±à¸™
      } else if (mode === 'monthly') {
        fromDate = new Date(new Date().getFullYear(), 0, 1); // à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸•à¹‰à¸™à¸›à¸µ
      } else {
        fromDate = new Date(new Date().getFullYear() - 4, 0, 1); // 4 à¸›à¸µà¸«à¸¥à¸±à¸‡
      }
    
      const { data, error } = await client
        .from('bills')
        .select('closed_at,total')
        .eq('status','closed')
        .gte('closed_at', fromDate.toISOString())
        .order('closed_at',{ascending:true});
    
      if (error) { console.error(error); return; }
    
      const grouped = {};
      data.forEach(b => {
        const d = new Date(b.closed_at);
        let key;
        if (mode === 'daily') key = d.toLocaleDateString('th-TH');
        if (mode === 'monthly') key = d.toLocaleString('th-TH', { year:'numeric', month:'short' });
        if (mode === 'yearly') key = d.getFullYear();
        grouped[key] = (grouped[key] || 0) + Number(b.total);
      });
    
      const labels = Object.keys(grouped);
      const totals = Object.values(grouped);
    
      const ctx = document.getElementById('salesChart').getContext('2d');
      if (salesChart) salesChart.destroy();
    
      salesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'à¸¢à¸­à¸”à¸‚à¸²à¸¢ (à¸šà¸²à¸—)',
            data: totals,
            backgroundColor: 
              mode === 'daily' ? '#24d67a' :
              mode === 'monthly' ? '#19d3d3' : '#3b82f6'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.raw.toLocaleString("th-TH") + " à¸šà¸²à¸—";
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString("th-TH");
                }
              }
            }
          }
        }
      });
    }

     async function loadSalesHistory() {
Â  Â  Â  const fromDate = document.getElementById('fromDate')?.value;
Â  Â  Â  const toDate = document.getElementById('toDate')?.value;
Â  Â  Â  const searchText = document.getElementById('searchText')?.value.trim();
Â  Â Â 
Â  Â  Â  // === 1. Query à¸šà¸´à¸¥à¹ƒà¸™à¸£à¹‰à¸²à¸™ (à¹‚à¸„à¹‰à¸”à¹€à¸”à¸´à¸¡) ===
Â  Â  Â  let queryBills = client.from('bills')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('status','closed')
Â  Â  Â  Â  .order('closed_at', { ascending: false })
Â  Â  Â  Â  .limit(100);
Â  Â Â 
Â  Â  Â  if (!fromDate && !toDate && !searchText) {
Â  Â  Â  Â  queryBills = queryBills.limit(10);
Â  Â  Â  } else {
Â  Â  Â  Â  if (fromDate) queryBills = queryBills.gte('closed_at', fromDate + " 00:00:00");
Â  Â  Â  Â  if (toDate) queryBills = queryBills.lte('closed_at', toDate + " 23:59:59");
Â  Â  Â  Â  if (searchText) {
Â  Â  Â  Â  Â  queryBills = queryBills.or(`billno.ilike.%${searchText}%,customer.ilike.%${searchText}%`);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  const { data: billsData, error: billsError } = await queryBills;

Â  Â  Â  // === 2. Query à¸‹à¸·à¹‰à¸­à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™ (à¹‚à¸„à¹‰à¸”à¹ƒà¸«à¸¡à¹ˆ) ===
Â  Â  Â  let queryTakehome = client.from('takehome_sales')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .order('created_at', { ascending: false })
Â  Â  Â  Â  .limit(100);

Â  Â  Â  // à¹ƒà¸Šà¹‰à¸•à¸±à¸§à¸à¸£à¸­à¸‡à¸§à¸±à¸™à¸—à¸µà¹ˆ (à¹à¸•à¹ˆà¹„à¸¡à¹ˆà¹ƒà¸Šà¹‰ searchText à¹€à¸à¸£à¸²à¸°à¹„à¸¡à¹ˆà¸¡à¸µà¸Šà¹ˆà¸­à¸‡à¹ƒà¸«à¹‰à¸„à¹‰à¸™)
Â  Â  Â  if (!fromDate && !toDate && !searchText) {
Â  Â  Â  Â  queryTakehome = queryTakehome.limit(10);
Â  Â  Â  } else {
Â  Â  Â  Â  if (fromDate) queryTakehome = queryTakehome.gte('created_at', fromDate + " 00:00:00");
Â  Â  Â  Â  if (toDate) queryTakehome = queryTakehome.lte('created_at', toDate + " 23:59:59");
Â  Â  Â  }
Â  Â  Â  const { data: takehomeData, error: takehomeError } = await queryTakehome;

Â  Â  Â  // === 3. Render à¸•à¸²à¸£à¸²à¸‡à¸šà¸´à¸¥à¹ƒà¸™à¸£à¹‰à¸²à¸™ (à¹‚à¸„à¹‰à¸”à¹€à¸”à¸´à¸¡) ===
Â  Â  Â  const tbody = document.getElementById('salesHistory');
Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  if (!billsError && billsData) {
Â  Â  Â  Â  data.forEach(bill => {
Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  Â  <td>${bill.billno}</td>
Â  Â  Â  Â  Â  Â  <td>${bill.customer || '-'}</td>
Â  Â  Â  Â  Â  Â  <td>${Number(bill.total).toLocaleString("th-TH")}</td>
Â  Â  Â  Â  Â  Â  <td>${bill.created_at ? new Date(bill.created_at).toLocaleString('th-TH') : '-'}</td>
Â  Â  Â  Â  Â  Â  <td>${bill.closed_at ? new Date(bill.closed_at).toLocaleString('th-TH') : '-'}</td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  <button onclick="reprintBill(${bill.id})" style="background:#ec4899; color:white; border:none; padding:4px 8px; border-radius:6px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-print"></i> à¸à¸´à¸¡à¸à¹Œà¸šà¸´à¸¥
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  <button onclick="openPOS(${bill.id})" style="background:#10b981; color:white; border:none; padding:4px 8px; border-radius:6px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-cash-register"></i> POS
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // === 4. Render à¸•à¸²à¸£à¸²à¸‡à¸‹à¸·à¹‰à¸­à¸à¸¥à¸±à¸šà¸šà¹‰à¸²à¸™ (à¹‚à¸„à¹‰à¸”à¹ƒà¸«à¸¡à¹ˆ) ===
Â  Â  Â  const tbodyTakehome = document.getElementById('takehomeHistory');
Â  Â  Â  tbodyTakehome.innerHTML = '';
Â  Â  Â  if (!takehomeError && takehomeData) {
Â  Â  Â  Â  takehomeData.forEach(sale => {
Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  Â  <td>${new Date(sale.created_at).toLocaleString('th-TH')}</td>
Â  Â  Â  Â  Â  Â  <td>${Number(sale.total_amount).toLocaleString("th-TH")}</td>
Â  Â  Â  Â  Â  Â  <td>${sale.print_type || '-'}</td>
Â  Â  Â  Â  Â  Â  <td style="font-size:12px; max-width:150px; overflow-wrap:break-word;">
Â  Â  Â  Â  Â  Â  Â  ${JSON.stringify(sale.items)}
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  tbodyTakehome.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }

    // ğŸ”¹ à¸—à¸³à¹ƒà¸«à¹‰à¸„à¹‰à¸™à¸«à¸²à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¹€à¸¡à¸·à¹ˆà¸­à¹à¸à¹‰à¹„à¸‚ input
    const filterInputs = document.querySelectorAll('#fromDate, #toDate, #searchText');
    filterInputs.forEach(input => {
      input.addEventListener('input', () => {
        loadSalesHistory();
      });
    });

    async function exportToExcel() {
      const { data, error } = await client
        .from('bills')
        .select('*')
        .eq('status','closed')
        .order('closed_at', { ascending: false });
    
      if (error) {
        alert("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸”à¹‰");
        return;
      }
    
      // à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸›à¹‡à¸™ array à¸ªà¸³à¸«à¸£à¸±à¸š Excel
      const exportData = data.map(bill => ({
        à¹€à¸¥à¸‚à¸šà¸´à¸¥: bill.billno,
        à¸¥à¸¹à¸à¸„à¹‰à¸²_à¹‚à¸•à¹Šà¸°: bill.customer || '-',
        à¸¢à¸­à¸”à¸£à¸§à¸¡: Number(bill.total).toLocaleString("th-TH"),
        à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸”à¸šà¸´à¸¥: bill.created_at ? new Date(bill.created_at).toLocaleString('th-TH') : '-',
        à¹€à¸§à¸¥à¸²à¸›à¸´à¸”à¸šà¸´à¸¥: bill.closed_at ? new Date(bill.closed_at).toLocaleString('th-TH') : '-'
      }));
          
      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "SalesHistory");
    
      XLSX.writeFile(wb, "sales_history.xlsx");
    }

    /* ======= à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Set IP (localStorage) ======= */
    function openIpModal() {
      const modal = document.getElementById('ipModal');
      const input = document.getElementById('printerIpInput');
      const currentIP = localStorage.getItem('PRINTER_IP') || '192.168.1.100';
      input.value = currentIP;
      modal.style.display = 'flex';
    }
    
    function closeIpModal() {
      document.getElementById('ipModal').style.display = 'none';
    }
    
    function saveIp() {
      const input = document.getElementById('printerIpInput');
      const ip = input.value.trim();
      if (ip === '') {
        localStorage.removeItem('PRINTER_IP');
        alert('à¸¥à¸šà¸„à¹ˆà¸² IP à¹à¸¥à¹‰à¸§ à¸ˆà¸°à¸à¸¥à¸±à¸šà¹„à¸›à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ 192.168.1.100');
      } else if (!validateIPv4(ip)) {
        alert('à¸£à¸¹à¸›à¹à¸šà¸š IP à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆ IPv4 à¹€à¸Šà¹ˆà¸™ 192.168.1.100');
        return;
      } else {
        localStorage.setItem('PRINTER_IP', ip);
        alert('à¸šà¸±à¸™à¸—à¸¶à¸ IP à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢: ' + ip);
      }
      updateIpLabel();
      closeIpModal();
    }
    
    function validateIPv4(ip) {
      const re = /^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/;
      return re.test(ip);
    }
    
    function updateIpLabel() {
      const label = document.getElementById('ipLabel');
      const ip = localStorage.getItem('PRINTER_IP') || '192.168.1.100';
      if (label) label.textContent = ip;
    }

    // à¹€à¸£à¸µà¸¢à¸à¹€à¸¡à¸·à¹ˆà¸­à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²
    window.addEventListener('DOMContentLoaded', updateIpLabel);
    // à¹€à¸£à¸µà¸¢à¸à¸‹à¹‰à¸³à¸­à¸µà¸à¹€à¸œà¸·à¹ˆà¸­à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸£à¸±à¸™à¸«à¸¥à¸±à¸‡ DOM à¹€à¸«à¸•à¸¸à¸à¸²à¸£à¸“à¹Œ
    updateIpLabel();
    /* ================================================ */

    // à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸šà¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™
    (async () => {
      await ensureTablesExist();
      await loadTables();
    })();

    // realtime update
    client.channel('tables-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'tables' }, payload => {
        const div = document.getElementById("table-" + payload.new.id);
        if (!div) return;
        const status = payload.new.status || "à¸§à¹ˆà¸²à¸‡";
        div.className = 'table-card ' + (status === 'à¸§à¹ˆà¸²à¸‡' ? 'free' : 'busy');
        div.innerHTML = `
          <i class="fa-solid ${status === 'à¸§à¹ˆà¸²à¸‡' ? 'fa-circle-check free' : 'fa-circle-xmark busy'} status-icon"></i>
          <span>${payload.new.id} (${status})</span>
        `;
      })
      .subscribe();

    document.getElementById('btnTakeHome').addEventListener('click', () => {
      window.open('takehome.html', '_blank');
    });
  </script>
</body>
</html>
