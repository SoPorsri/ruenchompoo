<!doctype html>
<html lang="th">
<head>
Â  <meta charset="utf-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <title>à¸£à¹‰à¸²à¸™à¹€à¸£à¸·à¸­à¸™à¸Šà¸¡à¸à¸¹à¹€à¸™à¸·à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸à¸²à¸«à¸¥à¸µ - à¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</title>
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
Â Â 
Â  <style>
Â  Â  body { font-family: system-ui, "Noto Sans Thai", sans-serif; margin: 0; background-color: #e6fff7; }
Â  Â  header {
Â  Â  Â  background: linear-gradient(90deg, #ec4899, #d946ef);
Â  Â  Â  color: white;
Â  Â  Â  padding: clamp(12px, 2vw, 16px);
Â  Â  Â  text-align: center;
Â  Â  Â  font-size: clamp(16px, 2.5vw, 20px);
Â  Â  Â  font-weight: bold;
Â  Â  Â  letter-spacing: 0.5px;
Â  Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
Â  Â  Â  position: relative;
Â  Â  }
Â  Â Â 
Â  Â  header img {
Â  Â  Â  height: 100px;
Â  Â  Â  vertical-align: middle;
Â  Â  Â  margin-right: 8px;
Â  Â  }
Â  Â Â 
Â  Â  header span {
Â  Â  Â  vertical-align: middle;
Â  Â  }

Â  Â  /* ===== Set IP button: à¸¡à¸¸à¸¡à¸‚à¸§à¸²à¸¥à¹ˆà¸²à¸‡à¸‚à¸­à¸‡ header ===== */
Â  Â  #setIpBtn {
Â  Â  Â  position: absolute; /* à¸«à¸£à¸·à¸­ fixed à¸–à¹‰à¸²à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¹ƒà¸«à¹‰à¹€à¸¥à¸·à¹ˆà¸­à¸™à¸•à¸²à¸¡à¸«à¸™à¹‰à¸² */
Â  Â  Â  right: clamp(10px, 2vw, 16px);
Â  Â  Â  top: calc(0 + clamp(0px, 2vw, 16px) + 100px); /* 100px = à¸„à¸§à¸²à¸¡à¸ªà¸¹à¸‡ header */
Â  Â  Â  background: linear-gradient(135deg, #f59e0b, #d97706);
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  padding: 8px 12px;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: 13px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 8px;
Â  Â  Â  z-index: 300;
Â  Â  }
Â  Â  #setIpBtn i { font-size: 14px; }
Â  Â  #setIpBtn small {
Â  Â  Â  display:block;
Â  Â  Â  font-weight:400;
Â  Â  Â  font-size:11px;
Â  Â  Â  opacity:0.95;
Â  Â  }
Â  Â  #setIpBtn:hover { transform: translateY(-2px); }

Â  Â  @media (max-width: 600px) {
Â  Â  Â  #setIpBtn {
Â  Â  Â  Â  padding: 6px 10px;
Â  Â  Â  Â  font-size:12px;
Â  Â  Â  Â  top: calc(0 + 72px + 8px); /* à¸›à¸£à¸±à¸šà¸•à¸²à¸¡ header à¸šà¸™à¸¡à¸·à¸­à¸–à¸·à¸­ */
Â  Â  Â  }
Â  Â  }
Â  Â  /* ================================================ */
Â  Â Â 
Â  Â  /* à¸›à¸¸à¹ˆà¸¡ Floating Action Button à¹à¸šà¸š Dynamic - à¸‚à¸™à¸²à¸”à¹€à¸¥à¹‡à¸à¸¥à¸‡ + à¸ªà¸µà¸ªà¸­à¸”à¸„à¸¥à¹‰à¸­à¸‡à¸à¸£à¸²à¸Ÿ */
Â  Â  #reportButton {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 6px;
Â  Â  Â  right: 6px;
Â  Â  Â  background: linear-gradient(135deg, #FBCFE8, #EC4899, #BE185D);
Â  Â  Â  color: #fff;
Â  Â  Â  border: none;
Â  Â  Â  padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 18px);
Â  Â  Â  border-radius: 50px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-size: clamp(12px, 1.8vw, 14px);
Â  Â  Â  font-weight: 600;
Â  Â  Â  box-shadow: 0 6px 20px rgba(190,24,93,0.35); /* à¹€à¸‡à¸²à¹‚à¸—à¸™à¹€à¸‚à¹‰à¸¡ */
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 4px;
Â  Â  Â  transition: transform 0.2s, box-shadow 0.2s;
Â  Â  Â  z-index: 100;
Â  Â  }
Â  Â Â 
Â  Â  /* Hover effect */
Â  Â  #reportButton:hover {
Â  Â  Â  transform: translateY(-3px) scale(1.05);
Â  Â  Â  box-shadow: 0 6px 20px rgba(0,0,0,0.35);
Â  Â  }
Â  Â Â 
Â  Â  /* Icon */
Â  Â  #reportButton i {
Â  Â  Â  font-size: clamp(14px, 1.8vw, 18px);
Â  Â  }
Â  Â Â 
Â  Â  /* Mobile Adjust */
Â  Â  @media (max-width: 600px) {
Â  Â  Â  #reportButton {
Â  Â  Â  Â  bottom: 12px;
Â  Â  Â  Â  right: 12px;
Â  Â  Â  Â  padding: 10px 16px;
Â  Â  Â  Â  font-size: 14px;
Â  Â  Â  }
Â  Â  Â  #reportButton i {
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  }
Â  Â  }

Â  Â  .layout {
Â  Â  Â  display: grid; grid-template-columns: 90px 90px 90px 90px;
Â  Â  Â  grid-template-rows: repeat(12, 60px); gap: 12px; padding: 24px;
Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â  .table-card {
Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  border-radius: 10px; font-size: 14px; font-weight: 600;
Â  Â  Â  cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;
Â  Â  Â  box-shadow: 0 3px 6px rgba(0,0,0,0.1);
Â  Â  Â  padding: 6px; text-align: center;
Â  Â  }
Â  Â  .table-card:hover { transform: translateY(-4px) scale(1.05); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
Â  Â  .free { background: linear-gradient(135deg, #34d399, #10b981); color: white; }
Â  Â  .busy { background: linear-gradient(135deg, #f87171, #ef4444); color: white; }
Â  Â  .status-icon { font-size: 18px; margin-right: 6px; }
Â  Â  .status-icon.free { color: #bbf7d0; }
Â  Â  .status-icon.busy { color: #fecaca; }

Â  Â  /* layout position */
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡1 { grid-column: 1; grid-row: 10; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡2 { grid-column: 1; grid-row: 9; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡3 { grid-column: 1; grid-row: 8; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡4 { grid-column: 1; grid-row: 7; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡5 { grid-column: 1; grid-row: 6; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡6 { grid-column: 1; grid-row: 5; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡7 { grid-column: 1; grid-row: 4; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡8 { grid-column: 1; grid-row: 3; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡9 { grid-column: 1; grid-row: 2; }
Â  Â  #table-à¸‹à¸¸à¹‰à¸¡10 { grid-column: 1; grid-row: 1; }

Â  Â  #table-A1 { grid-column: 2; grid-row: 8 / span 2; height:160px; width:80px; align-self:start; }
Â  Â  #table-A2 { grid-column: 3; grid-row: 8 / span 2; height:160px; width:80px; align-self:start; }
Â  Â  #table-A3 { grid-column:2 / span 2; grid-row:7; height:50px; }
Â  Â  #table-A4 { grid-column:2 / span 2; grid-row:6; height:50px; }
Â  Â  #table-A5 { grid-column:2 / span 2; grid-row:5; height:50px; }
Â  Â  #table-A6 { grid-column:2 / span 2; grid-row:4; height:50px; }
Â  Â  #table-A7 { grid-column:2 / span 2; grid-row:3; height:50px; }
Â  Â  #table-A8 { grid-column:2 / span 2; grid-row:2; height:50px; }

Â  Â  #table-B1 { grid-column: 4; grid-row: 8; }
Â  Â  #table-B2 { grid-column: 4; grid-row: 7; }
Â  Â  #table-B3 { grid-column: 4; grid-row: 6; }
Â  Â  #table-B4 { grid-column: 4; grid-row: 5; }
Â Â 
Â  Â  .layout {
Â  Â  Â  position: relative;
Â  Â  Â  z-index: 1; /* à¹‚à¸•à¹Šà¸°à¸­à¸¢à¸¹à¹ˆà¸‚à¹‰à¸²à¸‡à¸«à¸™à¹‰à¸² */
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <img src="images/LOGO.png" alt="à¹‚à¸¥à¹‚à¸à¹‰à¸£à¹‰à¸²à¸™">
Â  Â  <span>à¸£à¹‰à¸²à¸™à¹€à¸£à¸·à¸­à¸™à¸Šà¸¡à¸à¸¹à¹€à¸™à¸·à¹‰à¸­à¸¢à¹ˆà¸²à¸‡à¹€à¸à¸²à¸«à¸¥à¸µ â€¢ à¸ªà¸²à¸‚à¸²à¸™à¸²à¹€à¸Šà¸·à¸­à¸</span>
Â  </header>

Â  Â  <button id="setIpBtn" onclick="openIpModal()" aria-label="à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² IP à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œ">
Â  Â  <i class="fa-solid fa-network-wired"></i>
Â  Â  <div style="text-align:left; line-height:1;">
Â  Â  Â  <div style="font-weight:700; font-size:13px;">Set IP</div>
Â  Â  Â  <small id="ipLabel">192.168.1.100</small>
Â  Â  </div>
Â  </button>
Â Â 
Â  Â  <button id="reportButton" onclick="openReport()">
Â  Â  <i class="fa-solid fa-chart-line"></i> à¸”à¸¹à¸£à¸²à¸¢à¸‡à¸²à¸™
Â  </button>

Â  Â  <div id="ipModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
Â  Â  Â  Â background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000;">
Â  Â  <div style="background:white; padding:24px; border-radius:16px; width:90%; max-width:400px; box-shadow:0 6px 16px rgba(0,0,0,0.25);">
Â  Â  Â  <h3 style="margin-top:0;">à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² IP à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸à¸´à¸¡à¸à¹Œ</h3>
Â  Â  Â  <input type="text" id="printerIpInput" placeholder="192.168.1.100"Â 
Â  Â  Â  Â  Â  Â  Â style="width:100%; padding:8px; margin-bottom:16px; border-radius:8px; border:1px solid #ccc;">
Â  Â  Â  <div style="display:flex; justify-content:flex-end; gap:8px;">
Â  Â  Â  Â  <button onclick="closeIpModal()" style="background:#ccc; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">à¸¢à¸à¹€à¸¥à¸´à¸</button>
Â  Â  Â  Â  <button onclick="saveIp()" style="background:#f59e0b; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">à¸šà¸±à¸™à¸—à¸¶à¸</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â Â 
Â  <div class="layout" id="tables">
Â  Â  Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡1" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡2" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡3" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡4" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡5" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡6" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡7" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡8" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡9" class="table-card"></div>
Â  Â  <div id="table-à¸‹à¸¸à¹‰à¸¡10" class="table-card"></div>
Â  Â  <div id="table-A1" class="table-card"></div>
Â  Â  <div id="table-A2" class="table-card"></div>
Â  Â  <div id="table-A3" class="table-card"></div>
Â  Â  <div id="table-A4" class="table-card"></div>
Â  Â  <div id="table-A5" class="table-card"></div>
Â  Â  <div id="table-A6" class="table-card"></div>
Â  Â  <div id="table-A7" class="table-card"></div>
Â  Â  <div id="table-A8" class="table-card"></div>
Â  Â  <div id="table-B1" class="table-card"></div>
Â  Â  <div id="table-B2" class="table-card"></div>
Â  Â  <div id="table-B3" class="table-card"></div>
Â  Â  <div id="table-B4" class="table-card"></div>
Â  </div>

Â  <div id="reportModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;Â 
Â  background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
Â  Â  <div style="background:white; padding:24px; border-radius:16px; width:95%; max-width:900px; max-height:90%; overflow:auto;
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow:0 6px 16px rgba(0,0,0,0.25);">
Â  Â  Â Â 
Â  Â  Â  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
Â  Â  Â  Â  <h2 style="margin:0; color:#d946ef">ğŸ“Š à¸£à¸²à¸¢à¸‡à¸²à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢</h2>
Â  Â  Â  Â  <button onclick="closeReport()" style="border:none; background:none; font-size:22px; cursor:pointer; color:#666;">âœ–</button>
Â  Â  Â  </div>
Â Â 
Â  Â  Â  Â  Â  Â  <div style="display:flex; gap:20px; margin-bottom:24px; flex-wrap:wrap;">
Â  Â  Â  Â  Â  <div style="flex:1; background:#e8fdf2; padding:16px; border-radius:12px; text-align:center;">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0; color:#24d67a;">à¸§à¸±à¸™à¸™à¸µà¹‰</h3>
Â  Â  Â  Â  Â  Â  <p id="dailySales" style="font-size:20px; font-weight:bold; margin:4px 0;">0</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="flex:1; background:#e8f8ff; padding:16px; border-radius:12px; text-align:center;">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0; color:#19d3d3;">à¹€à¸”à¸·à¸­à¸™à¸™à¸µà¹‰</h3>
Â  Â  Â  Â  Â  Â  <p id="monthlySales" style="font-size:20px; font-weight:bold; margin:4px 0;">0</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="flex:1; background:#dbeafe; padding:16px; border-radius:12px; text-align:center;">
Â  Â  Â  Â  Â  Â  <h3 style="margin:0; color:#3b82f6;">à¸›à¸µà¸™à¸µà¹‰</h3>
Â  Â  Â  Â  Â  Â  <p id="yearlySales" style="font-size:20px; font-weight:bold; margin:4px 0;">0</p>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â Â 
Â  Â  Â  Â  Â  Â  <h3 style="margin-top:0;">ğŸ“ˆ à¸à¸£à¸²à¸Ÿà¸¢à¸­à¸”à¸‚à¸²à¸¢</h3>
Â  Â  Â  <div style="margin-bottom:12px;">
Â  Â  Â  Â  <button onclick="loadSalesChart('daily')"Â 
Â  Â  Â  Â  Â  style="background:#24d67a; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">
Â  Â  Â  Â  Â  à¸£à¸²à¸¢à¸§à¸±à¸™
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button onclick="loadSalesChart('monthly')"Â 
Â  Â  Â  Â  Â  style="background:#19d3d3; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">
Â  Â  Â  Â  Â  à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button onclick="loadSalesChart('yearly')"Â 
Â  Â  Â  Â  Â  style="background:#3b82f6; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">
Â  Â  Â  Â  Â  à¸£à¸²à¸¢à¸›à¸µ
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â  Â  Â  <canvas id="salesChart" height="120"></canvas>
Â Â 
Â  Â  Â  Â  Â  Â  <div style="margin-top:24px;">
Â  Â  Â  Â  <button onclick="toggleHistory()"Â 
Â  Â  Â  Â  Â  style="background:#ec4899; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer;">
Â  Â  Â  Â  Â  <i class="fa-solid fa-clock-rotate-left"></i> à¸”à¸¹à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸‚à¸²à¸¢
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button onclick="exportToExcel()"Â 
Â  Â  Â  Â  Â  style="background:#10b981; color:white; border:none; padding:10px 16px; border-radius:8px; cursor:pointer;">
Â  Â  Â  Â  Â  <i class="fa-solid fa-file-excel"></i> Export Excel
Â  Â  Â  Â  </button>
Â  Â  Â  </div>
Â Â 
Â  Â  Â  Â  Â  Â  <div id="historySection" style="display:none; margin-top:16px;">
Â  Â  Â  Â  <h3>ğŸ§¾ à¸›à¸£à¸°à¸§à¸±à¸•à¸´à¸à¸²à¸£à¸‚à¸²à¸¢à¸¥à¹ˆà¸²à¸ªà¸¸à¸”</h3>
Â  Â  Â  Â  <table border="1" cellpadding="6" cellspacing="0" style="width:100%; border-collapse:collapse; font-size:14px;">
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr style="background:#f9fafb;">
Â  Â  Â  Â  Â  Â  Â  <th>à¹€à¸¥à¸‚à¸šà¸´à¸¥</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¸¥à¸¹à¸à¸„à¹‰à¸²/à¹‚à¸•à¹Šà¸°</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¸¢à¸­à¸”à¸£à¸§à¸¡</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸”à¸šà¸´à¸¥</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¹€à¸§à¸¥à¸²à¸›à¸´à¸”à¸šà¸´à¸¥</th>
Â  Â  Â  Â  Â  Â  Â  <th>à¸à¸´à¸¡à¸à¹Œ</th>
Â  Â  Â  Â  Â  Â  Â  <th>ESC/POS</th>
Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody id="salesHistory"></tbody>
Â  Â  Â  Â  </table>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>


Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  <script>
Â  Â  const SUPABASE_URL = 'https://pklvscffpbapogezoxyn.supabase.co';
Â  Â  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrbHZzY2ZmcGJhcG9nZXpveHluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk1NTIxNTYsImV4cCI6MjA2NTEyODE1Nn0.O0cXyJAo0qdbNZsLqK1zpo1lS1H1mrudaGz2VaEQQaM';
Â  Â  const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

Â  Â  const tables = [
Â  Â  Â  { id: 1, name: "à¸‹à¸¸à¹‰à¸¡1" }, { id: 2, name: "à¸‹à¸¸à¹‰à¸¡2" }, { id: 3, name: "à¸‹à¸¸à¹‰à¸¡3" }, { id: 4, name: "à¸‹à¸¸à¹‰à¸¡4" },
Â  Â  Â  { id: 5, name: "à¸‹à¸¸à¹‰à¸¡5" }, { id: 6, name: "à¸‹à¸¸à¹‰à¸¡6" }, { id: 7, name: "à¸‹à¸¸à¹‰à¸¡7" }, { id: 8, name: "à¸‹à¸¸à¹‰à¸¡8" },
Â  Â  Â  { id: 9, name: "à¸‹à¸¸à¹‰à¸¡9" }, { id: 10, name: "à¸‹à¸¸à¹‰à¸¡10" }, { id: 11, name: "A1" }, { id: 12, name: "A2" },
Â  Â  Â  { id: 13, name: "A3" }, { id: 14, name: "A4" }, { id: 15, name: "A5" }, { id: 16, name: "A6" },
Â  Â  Â  { id: 17, name: "A7" }, { id: 18, name: "A8" }, { id: 19, name: "B1" }, { id: 20, name: "B2" },
Â  Â  Â  { id: 21, name: "B3" }, { id: 22, name: "B4" }
Â  Â  ];

Â  Â  // Hybrid Caching Functions
Â  Â  function saveTablesToCache(data) {
Â  Â  Â  localStorage.setItem('tables_cache', JSON.stringify(data));
Â  Â  }
Â Â 
Â  Â  function loadTablesFromCache() {
Â  Â  Â  const cached = localStorage.getItem('tables_cache');
Â  Â  Â  return cached ? JSON.parse(cached) : null;
Â  Â  }
Â Â 
Â  Â  function areTablesEqual(data1, data2) {
Â  Â  Â  if (!data1 || !data2 || data1.length !== data2.length) {
Â  Â  Â  Â  return false;
Â  Â  Â  }
Â  Â  Â  for (let i = 0; i < data1.length; i++) {
Â  Â  Â  Â  if (data1[i].id !== data2[i].id || data1[i].status !== data2[i].status) {
Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  return true;
Â  Â  }

Â  Â  function renderTables(data) {
Â  Â  Â  tables.forEach(t => {
Â  Â  Â  Â  const div = document.getElementById("table-" + t.name);
Â  Â  Â  Â  if (!div) return;

Â  Â  Â  Â  const record = data.find(d => d.id === t.id);
Â  Â  Â  Â  const status = record ? record.status : "à¸§à¹ˆà¸²à¸‡";

Â  Â  Â  Â  div.className = 'table-card ' + (status === 'à¸§à¹ˆà¸²à¸‡' ? 'free' : 'busy');
Â  Â  Â  Â  div.innerHTML = '';

Â  Â  Â  Â  const icon = document.createElement('i');
Â  Â  Â  Â  icon.className = status === 'à¸§à¹ˆà¸²à¸‡'
Â  Â  Â  Â  Â  ? 'fa-solid fa-circle-check status-icon free'
Â  Â  Â  Â  Â  : 'fa-solid fa-circle-xmark status-icon busy';

Â  Â  Â  Â  const label = document.createElement('span');
Â  Â  Â  Â  label.textContent = `${t.name} (${status})`;

Â  Â  Â  Â  div.appendChild(icon);
Â  Â  Â  Â  div.appendChild(label);

Â  Â  Â  Â  div.onclick = async () => {
Â  Â  Â  Â  Â  if (status === 'à¸§à¹ˆà¸²à¸‡') {
Â  Â  Â  Â  Â  Â  const { error: updateError } = await client.from('tables')
Â  Â  Â  Â  Â  Â  Â  .update({ status: 'à¹„à¸¡à¹ˆà¸§à¹ˆà¸²à¸‡' })
Â  Â  Â  Â  Â  Â  Â  .eq('id', t.id);
Â  Â  Â  Â  Â  Â  if (updateError) {
Â  Â  Â  Â  Â  Â  Â  console.error(updateError);
Â  Â  Â  Â  Â  Â  Â  alert('à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¹‚à¸•à¹Šà¸°à¸œà¸´à¸”à¸à¸¥à¸²à¸”');
Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  window.location.href = `bill.html?table_id=${t.id}`;
Â  Â  Â  Â  };
Â  Â  Â  });
Â  Â  }
Â Â 
Â  Â  async function ensureTablesExist() {
Â  Â  Â  const { data: dbTables, error } = await client.from('tables').select('id');
Â  Â  Â  if (error) { console.error(error); return; }
Â  Â  Â  const existingIds = dbTables.map(t => t.id);
Â  Â  Â  const missing = tables.filter(t => !existingIds.includes(t.id));

Â  Â  Â  if (missing.length > 0) {
Â  Â  Â  Â  console.log("Insert missing tables:", missing);
Â  Â  Â  Â  const { data, error: upsertError } = await client.from('tables').upsert(
Â  Â  Â  Â  Â  missing.map(m => ({ id: m.id, name: m.name, status: "à¸§à¹ˆà¸²à¸‡" }))
Â  Â  Â  Â  );
Â  Â  Â  Â  if (upsertError) {
Â  Â  Â  Â  Â  console.error("Upsert error:", upsertError);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  console.log("Upsert success:", data);
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }

Â  Â  async function loadTables() {
Â  Â  Â  // 1. à¸¥à¸­à¸‡à¹‚à¸«à¸¥à¸”à¸ˆà¸²à¸ cache à¸à¹ˆà¸­à¸™
Â  Â  Â  const cachedData = loadTablesFromCache();
Â  Â  Â  if (cachedData) {
Â  Â  Â  Â  console.log('Serving from cache.');
Â  Â  Â  Â  renderTables(cachedData);
Â  Â  Â  }

Â  Â  Â  // 2. à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸ Supabase
Â  Â  Â  const { data, error } = await client.from('tables').select('id,status');
Â  Â  Â  if (error) {
Â  Â  Â  Â  console.error('Error fetching tables from Supabase:', error);
Â  Â  Â  Â  if (!cachedData) {
Â  Â  Â  Â  Â  // à¸–à¹‰à¸² cache à¸à¹‡à¹„à¸¡à¹ˆà¸¡à¸µ, à¹à¸ªà¸”à¸‡à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ error
Â  Â  Â  Â  Â  document.getElementById('tables').innerHTML = '<p style="text-align:center;">à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸à¸²à¸™à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸”à¹‰ à¸à¸£à¸¸à¸“à¸²à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆà¸­à¸µà¸à¸„à¸£à¸±à¹‰à¸‡</p>';
Â  Â  Â  Â  }
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // 3. à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸–à¹‰à¸²à¹„à¸¡à¹ˆà¹€à¸—à¹ˆà¸²à¸à¸±à¸™ à¹ƒà¸«à¹‰à¸­à¸±à¸›à¹€à¸”à¸•à¹à¸¥à¸°à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ cache à¹ƒà¸«à¸¡à¹ˆ
Â  Â  Â  if (!areTablesEqual(cachedData, data)) {
Â  Â  Â  Â  console.log('New data fetched. Updating UI and cache.');
Â  Â  Â  Â  renderTables(data);
Â  Â  Â  Â  saveTablesToCache(data);
Â  Â  Â  } else {
Â  Â  Â  Â  console.log('Data is the same. No UI update needed.');
Â  Â  Â  }
Â  Â  }

Â  Â  let salesChart;

Â  Â  function openReport() {
Â  Â  Â  document.getElementById('reportModal').style.display = 'flex';
Â  Â  Â  loadSalesSummary();
Â  Â  Â  loadSalesChart('daily'); // à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
Â  Â  }
Â  Â  function closeReport() {
Â  Â  Â  document.getElementById('reportModal').style.display = 'none';
Â  Â  }
Â Â 
Â  Â  function toggleHistory() {
Â  Â  Â  const section = document.getElementById('historySection');
Â  Â  Â  if (section.style.display === 'none') {
Â  Â  Â  Â  section.style.display = 'block';
Â  Â  Â  Â  loadSalesHistory();
Â  Â  Â  } else {
Â  Â  Â  Â  section.style.display = 'none';
Â  Â  Â  }
Â  Â  }

Â  Â  function reprintBill(billId) {
Â  Â  Â  // à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸à¸´à¸¡à¸à¹Œà¸šà¸´à¸¥à¹ƒà¸«à¸¡à¹ˆ à¸à¸£à¹‰à¸­à¸¡à¸ªà¹ˆà¸‡ bill_id
Â  Â  Â  window.open(`printbill.html?bill_id=${billId}`, '_blank');
Â  Â  }

Â  Â  // --- à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹€à¸›à¸´à¸”à¸«à¸™à¹‰à¸²à¸à¸´à¸¡à¸à¹Œ ESC/POS ---
Â  Â  function openPOS(billId) {
Â  Â  Â  window.open(`printPOS.html?bill_id=${billId}`, '_blank');
Â  Â  }
Â  Â  Â Â 
Â  Â  async function loadSalesSummary() {
Â  Â  Â  const { data: daily } = await client.rpc('get_daily_sales');
Â  Â  Â  const { data: monthly } = await client.rpc('get_monthly_sales');
Â  Â  Â  const { data: yearly } = await client.rpc('get_yearly_sales');
Â  Â Â 
Â  Â  Â  document.getElementById('dailySales').textContent =Â 
Â  Â  Â  Â  (daily?.[0]?.total_sales || 0).toLocaleString("th-TH");
Â  Â  Â  document.getElementById('monthlySales').textContent =Â 
Â  Â  Â  Â  (monthly?.[0]?.total_sales || 0).toLocaleString("th-TH");
Â  Â  Â  document.getElementById('yearlySales').textContent =Â 
Â  Â  Â  Â  (yearly?.[0]?.total_sales || 0).toLocaleString("th-TH");
Â  Â  }
Â Â 
Â  Â  async function loadSalesChart(mode = 'daily') {
Â  Â  Â  let fromDate;
Â  Â  Â  if (mode === 'daily') {
Â  Â  Â  Â  fromDate = new Date(Date.now() - 30*24*60*60*1000); // 30 à¸§à¸±à¸™
Â  Â  Â  } else if (mode === 'monthly') {
Â  Â  Â  Â  fromDate = new Date(new Date().getFullYear(), 0, 1); // à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¸•à¹‰à¸™à¸›à¸µ
Â  Â  Â  } else {
Â  Â  Â  Â  fromDate = new Date(new Date().getFullYear() - 4, 0, 1); // 4 à¸›à¸µà¸«à¸¥à¸±à¸‡
Â  Â  Â  }
Â  Â Â 
Â  Â  Â  const { data, error } = await client
Â  Â  Â  Â  .from('bills')
Â  Â  Â  Â  .select('closed_at,total')
Â  Â  Â  Â  .eq('status','closed')
Â  Â  Â  Â  .gte('closed_at', fromDate.toISOString())
Â  Â  Â  Â  .order('closed_at',{ascending:true});
Â  Â Â 
Â  Â  Â  if (error) { console.error(error); return; }
Â  Â Â 
Â  Â  Â  const grouped = {};
Â  Â  Â  data.forEach(b => {
Â  Â  Â  Â  const d = new Date(b.closed_at);
Â  Â  Â  Â  let key;
Â  Â  Â  Â  if (mode === 'daily') key = d.toLocaleDateString('th-TH');
Â  Â  Â  Â  if (mode === 'monthly') key = d.toLocaleString('th-TH', { year:'numeric', month:'short' });
Â  Â  Â  Â  if (mode === 'yearly') key = d.getFullYear();
Â  Â  Â  Â  grouped[key] = (grouped[key] || 0) + Number(b.total);
Â  Â  Â  });
Â  Â Â 
Â  Â  Â  const labels = Object.keys(grouped);
Â  Â  Â  const totals = Object.values(grouped);
Â  Â Â 
Â  Â  Â  const ctx = document.getElementById('salesChart').getContext('2d');
Â  Â  Â  if (salesChart) salesChart.destroy();
Â  Â Â 
Â  Â  Â  salesChart = new Chart(ctx, {
Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  label: 'à¸¢à¸­à¸”à¸‚à¸²à¸¢ (à¸šà¸²à¸—)',
Â  Â  Â  Â  Â  Â  data: totals,
Â  Â  Â  Â  Â  Â  backgroundColor:Â 
Â  Â  Â  Â  Â  Â  Â  mode === 'daily' ? '#24d67a' :
Â  Â  Â  Â  Â  Â  Â  mode === 'monthly' ? '#19d3d3' : '#3b82f6'
Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  },
Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  legend: { display: false },
Â  Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  Â  Â  label: function(context) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  return context.raw.toLocaleString("th-TH") + " à¸šà¸²à¸—";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  Â  ticks: {
Â  Â  Â  Â  Â  Â  Â  Â  callback: function(value) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  return value.toLocaleString("th-TH");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  async function loadSalesHistory() {
Â  Â  Â  const { data, error } = await client
Â  Â  Â  Â  .from('bills')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('status','closed')
Â  Â  Â  Â  .order('closed_at', { ascending: false })
Â  Â  Â  Â  .limit(20);
Â  Â Â 
Â  Â  Â  const tbody = document.getElementById('salesHistory');
Â  Â  Â  tbody.innerHTML = '';
Â  Â  Â  if (!error && data) {
Â  Â  Â  Â  data.forEach(bill => {
Â  Â  Â  Â  Â  const tr = document.createElement('tr');
Â  Â  Â  Â  Â  tr.innerHTML = `
Â  Â  Â  Â  Â  Â  <td>${bill.billno}</td>
Â  Â  Â  Â  Â  Â  <td>${bill.customer || '-'}</td>
Â  Â  Â  Â  Â  Â  <td>${Number(bill.total).toLocaleString("th-TH")}</td>
Â  Â  Â  Â  Â  Â  <td>${bill.created_at ? new Date(bill.created_at).toLocaleString('th-TH') : '-'}</td>
Â  Â  Â  Â  Â  Â  <td>${bill.closed_at ? new Date(bill.closed_at).toLocaleString('th-TH') : '-'}</td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  <button onclick="reprintBill(${bill.id})"Â 
Â  Â  Â  Â  Â  Â  Â  Â  style="background:#ec4899; color:white; border:none; padding:4px 8px; border-radius:6px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-print"></i> à¸à¸´à¸¡à¸à¹Œà¸šà¸´à¸¥
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  <button onclick="openPOS(${bill.id})"Â 
Â  Â  Â  Â  Â  Â  Â  Â  style="background:#f59e0b; color:white; border:none; padding:4px 8px; border-radius:6px; cursor:pointer;">
Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-receipt"></i> ESC/POS
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  tbody.appendChild(tr);
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }


Â  Â  async function exportToExcel() {
Â  Â  Â  const { data, error } = await client
Â  Â  Â  Â  .from('bills')
Â  Â  Â  Â  .select('*')
Â  Â  Â  Â  .eq('status','closed')
Â  Â  Â  Â  .order('closed_at', { ascending: false });
Â  Â Â 
Â  Â  Â  if (error) {
Â  Â  Â  Â  alert("à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸”à¹‰");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â Â 
Â  Â  Â  // à¹à¸›à¸¥à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸›à¹‡à¸™ array à¸ªà¸³à¸«à¸£à¸±à¸š Excel
Â  Â  Â  const exportData = data.map(bill => ({
Â  Â  Â  Â  à¹€à¸¥à¸‚à¸šà¸´à¸¥: bill.billno,
Â  Â  Â  Â  à¸¥à¸¹à¸à¸„à¹‰à¸²_à¹‚à¸•à¹Šà¸°: bill.customer || '-',
Â  Â  Â  Â  à¸¢à¸­à¸”à¸£à¸§à¸¡: Number(bill.total).toLocaleString("th-TH"),
Â  Â  Â  Â  à¹€à¸§à¸¥à¸²à¹€à¸›à¸´à¸”à¸šà¸´à¸¥: bill.created_at ? new Date(bill.created_at).toLocaleString('th-TH') : '-',
Â  Â  Â  Â  à¹€à¸§à¸¥à¸²à¸›à¸´à¸”à¸šà¸´à¸¥: bill.closed_at ? new Date(bill.closed_at).toLocaleString('th-TH') : '-'
Â  Â  Â  }));
Â  Â  Â  Â  Â Â 
Â  Â  Â  const ws = XLSX.utils.json_to_sheet(exportData);
Â  Â  Â  const wb = XLSX.utils.book_new();
Â  Â  Â  XLSX.utils.book_append_sheet(wb, ws, "SalesHistory");
Â  Â Â 
Â  Â  Â  XLSX.writeFile(wb, "sales_history.xlsx");
Â  Â  }

Â  Â  /* ======= à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™ Set IP (localStorage) ======= */
Â  Â  function openIpModal() {
Â  Â  Â  const modal = document.getElementById('ipModal');
Â  Â  Â  const input = document.getElementById('printerIpInput');
Â  Â  Â  const currentIP = localStorage.getItem('PRINTER_IP') || '192.168.1.100';
Â  Â  Â  input.value = currentIP;
Â  Â  Â  modal.style.display = 'flex';
Â  Â  }
Â  Â Â 
Â  Â  function closeIpModal() {
Â  Â  Â  document.getElementById('ipModal').style.display = 'none';
Â  Â  }
Â  Â Â 
Â  Â  function saveIp() {
Â  Â  Â  const input = document.getElementById('printerIpInput');
Â  Â  Â  const ip = input.value.trim();
Â  Â  Â  if (ip === '') {
Â  Â  Â  Â  localStorage.removeItem('PRINTER_IP');
Â  Â  Â  Â  alert('à¸¥à¸šà¸„à¹ˆà¸² IP à¹à¸¥à¹‰à¸§ à¸ˆà¸°à¸à¸¥à¸±à¸šà¹„à¸›à¹ƒà¸Šà¹‰à¸„à¹ˆà¸²à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ 192.168.1.100');
Â  Â  Â  } else if (!validateIPv4(ip)) {
Â  Â  Â  Â  alert('à¸£à¸¹à¸›à¹à¸šà¸š IP à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡ à¸à¸£à¸¸à¸“à¸²à¹ƒà¸ªà¹ˆ IPv4 à¹€à¸Šà¹ˆà¸™ 192.168.1.100');
Â  Â  Â  Â  return;
Â  Â  Â  } else {
Â  Â  Â  Â  localStorage.setItem('PRINTER_IP', ip);
Â  Â  Â  Â  alert('à¸šà¸±à¸™à¸—à¸¶à¸ IP à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢: ' + ip);
Â  Â  Â  }
Â  Â  Â  updateIpLabel();
Â  Â  Â  closeIpModal();
Â  Â  }
Â  Â Â 
Â  Â  function validateIPv4(ip) {
Â  Â  Â  const re = /^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/;
Â  Â  Â  return re.test(ip);
Â  Â  }
Â  Â Â 
Â  Â  function updateIpLabel() {
Â  Â  Â  const label = document.getElementById('ipLabel');
Â  Â  Â  const ip = localStorage.getItem('PRINTER_IP') || '192.168.1.100';
Â  Â  Â  if (label) label.textContent = ip;
Â  Â  }

Â  Â  // à¹€à¸£à¸µà¸¢à¸à¹€à¸¡à¸·à¹ˆà¸­à¹‚à¸«à¸¥à¸”à¸«à¸™à¹‰à¸²
Â  Â  window.addEventListener('DOMContentLoaded', updateIpLabel);
Â  Â  // à¹€à¸£à¸µà¸¢à¸à¸‹à¹‰à¸³à¸­à¸µà¸à¹€à¸œà¸·à¹ˆà¸­à¸ªà¸„à¸£à¸´à¸›à¸•à¹Œà¸£à¸±à¸™à¸«à¸¥à¸±à¸‡ DOM à¹€à¸«à¸•à¸¸à¸à¸²à¸£à¸“à¹Œ
Â  Â  updateIpLabel();
Â  Â  /* ================================================ */

Â  Â  // à¹€à¸£à¸µà¸¢à¸‡à¸¥à¸³à¸”à¸±à¸šà¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™
Â  Â  (async () => {
Â  Â  Â  await ensureTablesExist();
Â  Â  Â  await loadTables();
Â  Â  })();

Â  Â  // realtime update
Â  Â  client.channel('tables-changes')
Â  Â  Â  .on('postgres_changes', { event: '*', schema: 'public', table: 'tables' }, payload => {
Â  Â  Â  Â  console.log('change detected', payload);
Â  Â  Â  Â  loadTables();
Â  Â  Â  })
Â  Â  Â  .subscribe();
Â  </script>
</body>
</html>
